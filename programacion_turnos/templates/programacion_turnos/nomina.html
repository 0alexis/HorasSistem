{% extends "admin/base_site.html" %}
{% load i18n static %}
{% load malla_extras %}

{% block extrastyle %}
<style>
    /* Variables consistentes con el proyecto */
    :root {
        --regency-red: #871F1B;
        --regency-red-dark: #6b191b;
        --regency-red-light: #a13832;
        --regency-gray: #f8f9fa;
        --regency-gray-dark: #64748b;
        --regency-text: #333;
        --border-radius: 8px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* ========== OCULTAR BREADCRUMB DJANGO ADMIN ========== */
    .breadcrumbs,
    div.breadcrumbs {
        display: none !important;
    }

    /* Tipografía consistente */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 13px;
        line-height: 1.4;
        color: var(--regency-text);
        background: var(--regency-gray);
        margin: 0;
    }

    /* Header principal más compacto */
    .main-header {
        background: var(--regency-red);
        color: white;
        padding: 1rem 1.5rem;
        margin: 0 0 1rem 0;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }

    .main-header h1 {
        font-size: 1.4rem;
        margin: 0 0 0.5rem 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .main-header h1::before {
        content: '📊';
        font-size: 1.2rem;
        padding: 0.25rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    .subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
        font-weight: 400;
    }

    /* Información de la programación más compacta */
    .programacion-info {
        background: white;
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        border-left: 3px solid var(--regency-red);
        border: 1px solid #e5e7eb;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
    }

    .info-label {
        font-size: 0.75rem;
        color: var(--regency-gray-dark);
        font-weight: 500;
        margin-bottom: 0.15rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 0.9rem;
        color: var(--regency-text);
        font-weight: 600;
    }

    /* Filtro más compacto y cercano */
    .filter-form {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        background: white;
        padding: 0.75rem 1rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid #e5e7eb;
        flex-wrap: wrap;
    }

    .filter-form label {
        font-weight: 500;
        font-size: 0.85rem;
        color: var(--regency-text);
        margin: 0;
    }

    .filter-form input[type="date"] {
        padding: 0.4rem 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.8rem;
        font-family: inherit;
        min-width: 130px;
    }

    .filter-form button {
        background: var(--regency-red);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.4rem 0.8rem;
        font-weight: 500;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap;
    }

    .filter-form button:hover {
        background: var(--regency-red-dark);
    }

    /* Agrupación de campos de fecha */
    .date-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .date-separator {
        color: var(--regency-gray-dark);
        font-weight: 500;
        font-size: 0.8rem;
        margin: 0 0.25rem;
    }

    /* Contenedor de tabla más compacto */
    .nomina-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e5e7eb;
    }

    .table-header {
        background: var(--regency-gray);
        padding: 0.75rem 1rem;
        border-bottom: 2px solid var(--regency-red);
    }

    .table-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--regency-text);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .table-title::before {
        content: '📋';
        font-size: 0.9rem;
    }

    /* Tabla más compacta */
    .table-wrapper {
        overflow-x: auto;
        max-width: 100%;
    }

    .nomina-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
        min-width: 800px;
    }

    .nomina-table th {
        background: var(--regency-gray);
        color: var(--regency-text);
        font-weight: 600;
        padding: 0.5rem 0.4rem;
        text-align: center;
        border-bottom: 2px solid var(--regency-red);
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.75rem;
    }

    .nomina-table th.empleado-header {
        text-align: left;
        min-width: 160px;
        max-width: 160px;
        position: sticky;
        left: 0;
        background: var(--regency-gray);
        z-index: 11;
    }

    .nomina-table th.fecha-header {
        min-width: 50px;
        font-size: 0.7rem;
        padding: 0.4rem 0.25rem;
    }

    .nomina-table td {
        padding: 0.4rem 0.25rem;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        font-size: 0.8rem;
    }

    /* Celda de empleado más compacta */
    .empleado-cell {
        background: white;
        border-right: 2px solid #e5e7eb;
        position: sticky;
        left: 0;
        z-index: 9;
        min-width: 160px;
        max-width: 160px;
        padding: 0.4rem 0.5rem !important;
    }

    .empleado-nombre {
        font-weight: 600;
        color: var(--regency-text);
        font-size: 0.75rem;
        margin-bottom: 1px;
        line-height: 1.2;
    }

    .empleado-apellido {
        font-weight: 500;
        color: var(--regency-text);
        font-size: 0.7rem;
        margin-bottom: 2px;
        line-height: 1.2;
    }

    .empleado-cedula,
    .empleado-cargo {
        font-size: 0.65rem;
        color: var(--regency-gray-dark);
        margin: 1px 0;
        line-height: 1.1;
    }

    .empleado-cargo {
        font-style: italic;
        font-weight: 400;
    }

    /* Celdas de turno más pequeñas */
    .turno-cell {
        text-align: center;
        min-width: 50px;
        padding: 0.3rem 0.2rem !important;
    }

    .turno-letra {
        display: inline-block;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.75rem;
        line-height: 28px;
        text-align: center;
        color: #000;
        border: 1.5px solid transparent;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }

    .turno-letra:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
        z-index: 10;
    }

    .turno-vacio {
        color: var(--regency-gray-dark);
        font-size: 0.7rem;
        font-weight: 500;
    }

    /* Colores para diferentes turnos - más consistentes */
    .turno-A { background: #dbeafe; color: #1e40af; border-color: #3b82f6; }
    .turno-B { background: #dcfce7; color: #166534; border-color: #22c55e; }
    .turno-C { background: #fef3c7; color: #92400e; border-color: #f59e0b; }
    .turno-D { background: #fef2f2; color: #991b1b; border-color: #ef4444; }
    .turno-E { background: #faf5ff; color: #581c87; border-color: #a855f7; }
    .turno-F { background: #f0f9ff; color: #0c4a6e; border-color: #0ea5e9; }
    .turno-G { background: #f0fdf4; color: #14532d; border-color: #16a34a; }
    .turno-H { background: #fff7ed; color: #9a3412; border-color: #ea580c; }
    .turno-I { background: #fdf2f8; color: #831843; border-color: #ec4899; }
    .turno-J { background: #e0e7ff; color: #3730a3; border-color: #6366f1; }

    /* Estados especiales */
    .festivo {
        background: #fde68a !important;
        border: 2px solid #f59e0b !important;
        font-weight: 700 !important;
    }

    .domingo {
        background: #e0e7ff !important;
        border: 2px solid #6366f1 !important;
        font-weight: 700 !important;
    }

    .festivo.domingo {
        background: #fde68a !important;
        border: 2px solid #f59e0b !important;
    }

    /* Columna de total más destacada */
    .total-column {
        background: #fef2f2 !important;
        text-align: center;
        font-weight: 600;
        color: var(--regency-red) !important;
        border-left: 2px solid var(--regency-red);
        font-size: 0.85rem !important;
    }

    /* Resumen más compacto */
    .resumen-horas {
        background: var(--regency-gray);
        border-top: 2px solid #e5e7eb;
        padding: 0.75rem 1rem;
    }

    .resumen-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--regency-red);
        margin-bottom: 0.25rem;
    }

    .resumen-horas p {
        color: var(--regency-gray-dark);
        margin: 0;
        font-size: 0.8rem;
    }

    /* Leyenda más compacta */
    .leyenda-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e5e7eb;
    }

    .leyenda-container h3 {
        color: var(--regency-red);
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .leyenda-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.5rem;
    }

    .leyenda-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: #f8fafc;
        border-radius: 6px;
        border: 1px solid #f0f0f0;
    }

    .leyenda-item .turno-letra {
        width: 24px !important;
        height: 24px !important;
        line-height: 24px !important;
        font-size: 0.7rem !important;
        flex-shrink: 0;
    }

    .leyenda-text {
        flex: 1;
    }

    .leyenda-nombre {
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--regency-text);
        margin-bottom: 1px;
        line-height: 1.2;
    }

    .leyenda-descripcion {
        font-size: 0.7rem;
        color: var(--regency-gray-dark);
        line-height: 1.1;
        margin-bottom: 1px;
    }

    .leyenda-horas {
        font-size: 0.7rem;
        color: var(--regency-red);
        font-weight: 600;
    }

    /* Botón de regreso más compacto */
    .btn {
        background: var(--regency-red);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        margin-top: 1rem;
    }

    .btn:hover {
        background: var(--regency-red-dark);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    /* Hover de filas más sutil */
    .nomina-table tr:hover {
        background-color: #f8fafc;
    }

    .nomina-table tr:hover .empleado-cell {
        background-color: #f8fafc;
    }

    /* Responsive optimizado */
    @media (max-width: 1024px) {
        .empleado-header,
        .empleado-cell {
            min-width: 140px;
            max-width: 140px;
        }

        .empleado-nombre {
            font-size: 0.7rem;
        }

        .empleado-apellido {
            font-size: 0.65rem;
        }

        .empleado-cedula,
        .empleado-cargo {
            font-size: 0.6rem;
        }
    }

    @media (max-width: 768px) {
        .main-header {
            padding: 0.75rem 1rem;
        }

        .main-header h1 {
            font-size: 1.2rem;
        }

        .subtitle {
            font-size: 0.8rem;
        }

        .filter-form {
            flex-direction: column;
            gap: 0.5rem;
            align-items: stretch;
        }

        .info-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .nomina-container {
            margin: 0 -0.5rem;
            border-radius: 0;
        }

        .empleado-header,
        .empleado-cell {
            min-width: 120px;
            max-width: 120px;
        }

        .turno-letra {
            width: 24px !important;
            height: 24px !important;
            line-height: 24px !important;
            font-size: 0.7rem !important;
        }

        .leyenda-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Colores dinámicos para turnos basados en la base de datos */
    {% for codigo in codigos_turno %}
        .turno-{{ codigo.letra }} { 
            background: {{ codigo.color|default:"#f3f4f6" }}; 
            {% if codigo.color %}
                border-color: {{ codigo.color }};
            {% endif %}
        }
    {% endfor %}

    /* Estilos de respaldo para turnos no definidos */
    .turno-letra:not([class*="turno-"]) {
        background: #f3f4f6;
        border-color: #d1d5db;
        color: var(--regency-gray-dark);
    }

    /* Animaciones suaves */
    .nomina-container,
    .main-header,
    .programacion-info {
        animation: fadeInUp 0.3s ease forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-header">
    <h1> Nómina - Programación de Turnos</h1>
    <div class="subtitle">Conversión de turnos a horas trabajadas</div>
    
</div>
<!-- Botón de regreso -->

<!-- Información de la programación -->
<div class="programacion-info">
    <div class="info-grid">
        <div class="info-item">
            <span class="info-label">🏢 Centro Operativo</span>
            <span class="info-value">{{ programacion.centro_operativo.nombre }}</span>
        </div>

        <div class="info-item">
            <span class="info-label">👥 Total Empleados</span>
            <span class="info-value">{{ empleados|length }}</span>
        </div>

        <!-- Filtro integrado en la misma fila -->
        <div class="info-item" style="grid-column: span 2; margin-top: 0.5rem;">
            <form method="get" class="filter-form" style="
                margin: 0; 
                padding: 0.5rem 0; 
                background: transparent; 
                border: none; 
                box-shadow: none;
                justify-content: flex-start;
            ">
                <div class="date-group">
                    <label for="fecha_inicio">📅 Desde:</label>
                    <input type="date" name="fecha_inicio" id="fecha_inicio" 
                           value="{{ request.GET.fecha_inicio|default:programacion.fecha_inicio|date:'Y-m-d' }}">
                </div>
                
                <span class="date-separator">→</span>
                
                <div class="date-group">
                    <label for="fecha_fin">Hasta:</label>
                    <input type="date" name="fecha_fin" id="fecha_fin" 
                           value="{{ request.GET.fecha_fin|default:programacion.fecha_fin|date:'Y-m-d' }}">
                </div>
                
                <button type="submit">🔍 Filtrar</button>
            </form>
        </div>
    </div>
</div>


<!-- Botón de regreso más integrado -->
<div style="margin-bottom: 1rem;">
    <a href="{% url 'malla_turnos' programacion.id %}" class="btn">
        ← Volver a la Malla
    </a>
</div>
<!-- Tabla de nómina -->
<div class="nomina-container">
    <div class="table-header">
        <h3 class="table-title">Detalle de Turnos por Empleado</h3>
        
    </div>
    
    <div class="table-wrapper">
        <table class="nomina-table">
            <thead>
                <tr>
                    <th class="empleado-header">👤 Empleado</th>
                    {% for fecha in fechas %}
                        <th class="fecha-header">
                            {{ fecha|date:"d" }}<br>
                            <small>{{ fecha|date:"D" }}</small>
                        </th>
                    {% endfor %}
                    <th style="background: #fee2e2; color: var(--regency-red);">📊 Total Horas</th>
                </tr>
            </thead>
            <tbody>
                {% for empleado in empleados %}
                <tr>
                    <td class="empleado-cell">
                        <div class="empleado-nombre">{{ empleado.nombre_tercero }}</div>
                        <div class="empleado-apellido">{{ empleado.apellido_tercero }}</div>
                        <div class="empleado-cedula">Cédula: {{ empleado.documento|default:"-" }}</div>
                        <div class="empleado-cargo">{{ empleado.cargo_predefinido.nombre|default:"Sin cargo" }}</div>
                </td>
                    {% for fecha in fechas %}
                        {% with fecha_str=fecha|date:"Y-m-d" %}
                            {% with turno_letra=matriz_empleados_fechas|dict_get:empleado.id_tercero|dict_get:fecha_str %}
                                <td class="turno-cell" data-fecha="{{ fecha|date:'Y-m-d' }}">
                                    {% if turno_letra and turno_letra != '-' %}
                                        <span class="turno-letra turno-{{ turno_letra }}">{{ turno_letra }}</span>
                                    {% else %}
                                        <span class="turno-vacio">-</span>
                                    {% endif %}
                                </td>
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                    <td style="background: #fee2e2; text-align: center; font-weight: bold; color: var(--regency-red);">
                        <span id="total-horas-{{ empleado.id_tercero }}">
                            {{ total_horas_por_empleado|dict_get:empleado.id_tercero }} hrs
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ fechas|length|add:2 }}" style="text-align: center; padding: 2rem; color: #6b7280;">
                        No hay empleados asignados a esta programación.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Resumen de horas (próxima fase) -->
    <div class="resumen-horas">
        <div class="resumen-title">📋 Próxima fase: Conversión a horas</div>
        <p style="color: #6b7280; margin: 0;">
            En la siguiente iteración implementaremos el cálculo automático de horas basado en los códigos de turno.
        </p>
    </div>
</div>



<!-- Leyenda de códigos de turno usados en la programación -->
<div class="leyenda-container">
    <h3>🎯 Códigos de Turno</h3>
    <div class="leyenda-grid">
        {% for codigo in codigos_turno_usados %}
            <div class="leyenda-item">
                <span class="turno-letra turno-{{ codigo.letra_turno }}" style="width: 24px; height: 24px; line-height: 24px; font-size: 0.85rem;">
                    {{ codigo.letra_turno }}
                </span>
                <div class="leyenda-text">
                    <div class="leyenda-nombre">
                        {{ codigo.nombre|default:codigo.letra_turno }}
                    </div>
                    {% if codigo.descripcion_novedad %}
                        <div class="leyenda-descripcion">
                            {{ codigo.descripcion_novedad|truncatechars:40 }}
                        </div>
                    {% endif %}
                    <div class="leyenda-horas">
                        <strong>Horas:</strong> {{ codigo.duracion_total|default:"0" }}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>






<script>
    const festivos = {{ festivos_lista_json|safe }};
    const domingos = {{ domingos_lista_json|safe }};  // NUEVO
    
    function esFestivo(fechaStr) {
        return festivos && festivos.includes(fechaStr);
    }
    
    function esDomingo(fechaStr) {
        return domingos && domingos.includes(fechaStr);  // Usar la lista del backend
    }
    
    console.log('Festivos cargados:', festivos.length);
    console.log('Domingos cargados:', domingos.length);  // NUEVO
</script>
<script src="{% static 'malla/js/holidays.js' %}"></script>

{% endblock %}