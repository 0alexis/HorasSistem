{% extends "admin/base_site.html" %}
{% load i18n static %}
{% load malla_extras %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* Variables consistentes con el proyecto */
    :root {
        --regency-red: #871F1B;
        --regency-red-dark: #6b191b;
        --regency-red-light: #a13832;
        --regency-gray: #f8f9fa;
        --regency-gray-dark: #64748b;
        --regency-text: #333;
        --border-radius: 8px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* ========== OCULTAR BREADCRUMB DJANGO ADMIN ========== */
    .breadcrumbs,
    div.breadcrumbs {
        display: none !important;
    }

    /* Tipografía consistente */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 13px;
        line-height: 1.4;
        color: var(--regency-text);
        background: var(--regency-gray);
    }
    
    /* Header más compacto */
    .main-header {
        background: var(--regency-red);
        color: white;
        padding: 1rem 1.5rem;
        margin: 0 0 1rem 0;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }
    
    .main-header h1 {
        margin: 0 0 0.75rem 0;
        font-size: 1.3rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .main-header h1::before {
        content: '📋';
        font-size: 1.1rem;
        padding: 0.25rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
    
    /* Stats más compactas */
    .programacion-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
        margin: 0;
        opacity: 0.95;
    }
    
    .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.6rem 0.75rem;
        border-radius: 6px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 1.1rem;
        font-weight: 700;
        display: block;
        line-height: 1.2;
    }
    
    .stat-label {
        font-size: 0.75rem;
        margin-top: 0.15rem;
        opacity: 0.9;
        font-weight: 500;
    }
    
    /* Breadcrumb más pequeño */
    .breadcrumb-custom {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: var(--border-radius);
        padding: 0.6rem 1rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        font-size: 0.85rem;
    }
    
    .breadcrumb-custom a {
        color: var(--regency-red);
        text-decoration: none;
        font-weight: 500;
        margin-right: 0.4rem;
        transition: color 0.2s ease;
    }
    
    .breadcrumb-custom a:hover {
        color: var(--regency-red-dark);
    }
    
    /* Contenedor de la malla optimizado */
    .malla-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        overflow-x: auto;
        border: 1px solid #e5e7eb;
    }
    
    .malla-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
        font-size: 0.8rem; /* Tabla más compacta */
    }
    
    /* Headers más pequeños */
    .malla-table th {
        background: var(--regency-gray);
        color: var(--regency-text);
        font-weight: 600;
        padding: 0.5rem 0.4rem;
        text-align: center;
        border-bottom: 2px solid var(--regency-red);
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.75rem;
    }
    
    /* Columna de empleados MÁS COMPACTA */
    .empleado-header {
        text-align: left;
        min-width: 160px; /* Reducido de 200px */
        max-width: 160px;
        position: sticky;
        left: 0;
        background: var(--regency-gray);
        z-index: 11;
    }
    
    /* Headers de fecha más pequeños */
    .fecha-header {
        min-width: 50px; /* Reducido de 80px */
        text-align: center;
        padding: 0.4rem 0.25rem;
    }
    
    .fecha-dia {
        font-size: 0.9rem; /* Reducido de 1.1rem */
        font-weight: 700;
        color: var(--regency-red);
        line-height: 1;
    }
    
    .fecha-mes {
        font-size: 0.65rem; /* Reducido de 0.8rem */
        color: var(--regency-gray-dark);
        margin-top: 1px;
    }
    
    .fecha-dow {
        font-size: 0.6rem; /* Reducido de 0.7rem */
        color: #9ca3af;
        text-transform: uppercase;
        margin-top: 1px;
    }
    
    /* Celdas más compactas */
    .malla-table td {
        padding: 0.4rem 0.25rem; /* Reducido padding */
        border-bottom: 1px solid #e5e7eb;
        text-align: center;
        vertical-align: middle;
        font-size: 0.8rem;
    }
    
    /* Información de empleados MÁS COMPACTA */
    .empleado-cell {
        text-align: left;
        min-width: 160px; /* Reducido de 200px */
        max-width: 160px;
        position: sticky;
        left: 0;
        background: white;
        border-right: 2px solid #e5e7eb;
        z-index: 9;
        padding: 0.4rem 0.5rem !important; /* Padding específico */
    }
    
    .empleado-nombre {
        font-weight: 600;
        color: var(--regency-text);
        font-size: 0.75rem; /* Reducido de 0.9rem */
        line-height: 1.2;
        margin-bottom: 1px;
    }

    .empleado-apellido {
        font-weight: 500;
        color: var(--regency-text);
        font-size: 0.7rem; /* Nuevo - apellido más pequeño */
        line-height: 1.2;
        margin-bottom: 2px;
    }

    .empleado-cedula {
        font-size: 0.65rem; /* Reducido de 0.8rem */
        color: var(--regency-gray-dark);
        margin: 1px 0;
        font-weight: 500;
    }
    
    .empleado-cargo {
        font-size: 0.65rem; /* Reducido de 0.8rem */
        color: var(--regency-gray-dark);
        margin-top: 1px;
        font-style: italic;
        font-weight: 400;
    }
    
    /* Celdas de turno más pequeñas */
    .turno-cell {
        min-width: 50px; /* Reducido de 80px */
        position: relative;
        padding: 0.3rem 0.2rem !important;
    }
    
    /* Letras de turno más pequeñas */
    .turno-letra {
        display: inline-block;
        width: 28px; /* Reducido de 40px */
        height: 28px; /* Reducido de 40px */
        line-height: 28px;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.75rem; /* Reducido de 0.9rem */
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        user-select: none;
        border-width: 1.5px !important;
    }
    
    .turno-letra:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
        z-index: 10;
    }
    
    .turno-letra.editable {
        cursor: pointer;
        border: 1.5px solid transparent;
    }
    
    .turno-letra.editable:hover {
        border-color: var(--regency-red) !important;
        border-width: 2px !important;
    }
    
    /* Colores optimizados para mejor contraste */
    .turno-F { background: #fef3c7; color: #92400e; border: 1.5px solid #f59e0b; }
    .turno-H { background: #dbeafe; color: #1e40af; border: 1.5px solid #3b82f6; }
    .turno-D { background: #dcfce7; color: #166534; border: 1.5px solid #22c55e; }
    .turno-N { background: #e0e7ff; color: #3730a3; border: 1.5px solid #6366f1; }
    .turno-L { background: #fce7f3; color: #be185d; border: 1.5px solid #ec4899; }
    .turno-A { background: #fef2f2; color: #991b1b; border: 1.5px solid #ef4444; }
    .turno-B { background: #f0f9ff; color: #0c4a6e; border: 1.5px solid #0ea5e9; }
    .turno-C { background: #f0fdf4; color: #14532d; border: 1.5px solid #16a34a; }
    .turno-E { background: #faf5ff; color: #581c87; border: 1.5px solid #a855f7; }
    .turno-G { background: #fff7ed; color: #9a3412; border: 1.5px solid #ea580c; }
    .turno-I { background: #f0f9ff; color: #1e40af; border: 1.5px solid #3b82f6; }
    .turno-J { background: #fefce8; color: #854d0e; border: 1.5px solid #eab308; }
    .turno-K { background: #fdf2f8; color: #831843; border: 1.5px solid #ec4899; }
    .turno-M { background: #f0fdfa; color: #134e4a; border: 1.5px solid #14b8a6; }
    .turno-O { background: #fef3c7; color: #92400e; border: 1.5px solid #f59e0b; }
    .turno-P { background: #dbeafe; color: #1e40af; border: 1.5px solid #3b82f6; }
    .turno-Q { background: #dcfce7; color: #166534; border: 1.5px solid #22c55e; }
    .turno-R { background: #e0e7ff; color: #3730a3; border: 1.5px solid #6366f1; }
    .turno-S { background: #fce7f3; color: #be185d; border: 1.5px solid #ec4899; }
    .turno-T { background: #fef2f2; color: #991b1b; border: 1.5px solid #ef4444; }
    .turno-U { background: #f0f9ff; color: #0c4a6e; border: 1.5px solid #0ea5e9; }
    .turno-V { background: #f0fdf4; color: #14532d; border: 1.5px solid #16a34a; }
    .turno-W { background: #faf5ff; color: #581c87; border: 1.5px solid #a855f7; }
    .turno-X { background: #fff7ed; color: #9a3412; border: 1.5px solid #ea580c; }
    .turno-Y { background: #f0f9ff; color: #1e40af; border: 1.5px solid #3b82f6; }
    .turno-Z { background: #fefce8; color: #854d0e; border: 1.5px solid #eab308; }
    .turno-vacio { background: #f9fafb; color: #9ca3af; border: 1.5px dashed #d1d5db; }
    
    /* Hover de filas más sutil */
    .malla-table tr:hover {
        background-color: #f8fafc;
    }
    
    .malla-table tr:hover .empleado-cell {
        background-color: #f8fafc;
    }
    
    /* Fila de resumen más compacta */
    .malla-table tr[style*="border-top"] .turno-cell {
        padding: 0.25rem 0.1rem !important;
    }

    .malla-table tr[style*="border-top"] .turno-letra {
        width: 14px !important;
        height: 14px !important;
        line-height: 14px !important;
        font-size: 0.6rem !important;
        border-width: 1px !important;
    }
    
    /* Filtros más compactos */
    #filtro-fechas-malla input[type="date"] {
        padding: 0.25rem 0.4rem;
        font-size: 0.8rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
    }

    #filtro-fechas-malla button {
        background: var(--regency-red);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.25rem 0.6rem;
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    #filtro-fechas-malla button:hover {
        background: var(--regency-red-dark);
    }

    /* Botones de acción más pequeños */
    .btn-regency {
        background: var(--regency-red);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-regency:hover {
        background: var(--regency-red-dark);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    /* Leyenda más compacta */
    .leyenda-container {
        margin-top: 1rem;
        background: white;
        border-radius: var(--border-radius);
        padding: 1rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid #e5e7eb;
    }

    .leyenda-container h3 {
        margin: 0 0 0.75rem 0;
        color: var(--regency-text);
        font-size: 1rem;
        font-weight: 600;
    }

    .leyenda-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
    }

    .leyenda-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem;
    }

    .leyenda-item .turno-letra {
        width: 20px !important;
        height: 20px !important;
        line-height: 20px !important;
        font-size: 0.65rem !important;
        flex-shrink: 0;
    }

    .leyenda-text {
        font-size: 0.75rem;
        line-height: 1.2;
    }

    .leyenda-desc {
        font-weight: 500;
        color: var(--regency-text);
        margin-bottom: 1px;
    }

    .leyenda-info {
        color: var(--regency-gray-dark);
        font-size: 0.7rem;
    }
    
    /* Responsive más eficiente */
    @media (max-width: 1024px) {
        .empleado-header,
        .empleado-cell {
            min-width: 140px;
            max-width: 140px;
        }

        .empleado-nombre {
            font-size: 0.7rem;
        }

        .empleado-apellido {
            font-size: 0.65rem;
        }

        .empleado-cedula,
        .empleado-cargo {
            font-size: 0.6rem;
        }
    }

    @media (max-width: 768px) {
        .main-header {
            padding: 0.75rem 1rem;
        }

        .main-header h1 {
            font-size: 1.1rem;
        }

        .programacion-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .stat-item {
            padding: 0.5rem;
        }

        .stat-number {
            font-size: 1rem;
        }

        .stat-label {
            font-size: 0.7rem;
        }

        .malla-container {
            margin: 0 -0.5rem;
            border-radius: 0;
        }

        .empleado-header,
        .empleado-cell {
            min-width: 120px;
            max-width: 120px;
        }

        .turno-letra {
            width: 24px !important;
            height: 24px !important;
            line-height: 24px !important;
            font-size: 0.7rem !important;
        }
    }

    /* Animaciones suaves */
    .malla-container,
    .main-header,
    .breadcrumb-custom {
        animation: fadeInUp 0.3s ease forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-header">
    <h1>{{ title }}</h1>
    <div class="programacion-stats">
        <div class="stat-item">
            <span class="stat-number">{{ total_empleados }}</span>
            <span class="stat-label">Empleados</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ total_dias }}</span>
            <span class="stat-label">Días Programados</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ total_turnos }}</span>
            <span class="stat-label">Turnos Asignados</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ programacion.modelo_turno.nombre }}</span>
            <span class="stat-label">Modelo de Turno</span>
        </div>
    </div>
</div>

<div class="breadcrumb-custom">
    <a href="{% url 'programacion_dashboard' %}">← Centros Operativos</a>
    <span style="color: #6b7280;">|</span>
    <a href="{% url 'programaciones_por_centro' programacion.centro_operativo.id_centro %}">
        {{ programacion.centro_operativo.nombre }}
    </a>
    <span style="color: #6b7280;">| Malla de Turnos</span>
</div>

<!-- Filtro pequeño de rango de fechas + Botón de Nómina -->
<div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; background: #f8fafc; padding: 0.5rem 1rem; border-radius: 8px;">
    <!-- Filtro de fechas (lado izquierdo) -->
    <form id="filtro-fechas-malla" method="get" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
        <label style="font-weight: 500;">Desde:</label>
        <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ fecha_inicio|date:'Y-m-d' }}" style="padding: 0.2rem 0.5rem;">
        <label style="font-weight: 500;">Hasta:</label>
        <input type="date" name="fecha_fin" id="fecha_fin" value="{{ fecha_fin|date:'Y-m-d' }}" style="padding: 0.2rem 0.5rem;">
        <button type="submit" style="background: #0ea5e9; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.8rem; font-weight: 500;">Filtrar</button>
    </form>
    

    <!-- Botón de Nómina (lado derecho) -->
<div style="display: flex; gap: 0.5rem;">
    {% if programacion and programacion.id %}
        <a href="{% url 'nomina_view' programacion.id %}"
           style="background: linear-gradient(135deg, var(--regency-red) 0%, var(--regency-red-dark) 100%);
                  color: white;
                  border: none;
                  border-radius: 6px;
                  padding: 0.5rem 1rem;
                  font-weight: 600;
                  text-decoration: none;
                  display: inline-flex;
                  align-items: center;
                  gap: 0.5rem;
                  font-size: 0.9rem;
                  transition: all 0.2s ease;
                  box-shadow: 0 2px 4px rgba(185, 28, 28, 0.2);">
            📊 Ver Nómina
        </a>
    {% endif %}
        
        <!-- Botón adicional: Exportar (para futuro) -->
        <button type="button" 
                style="
                    background: transparent;
                    color: var(--regency-red);
                    border: 2px solid var(--regency-red);
                    border-radius: 6px;
                    padding: 0.4rem 0.8rem;
                    font-weight: 600;
                    cursor: pointer;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    font-size: 0.9rem;
                    transition: all 0.2s ease;
                "
                onmouseover="this.style.background='var(--regency-red)'; this.style.color='white';"
                onmouseout="this.style.background='transparent'; this.style.color='var(--regency-red)';"
                onclick="alert('Funcionalidad de exportar próximamente')">
            📤 Exportar
        </button>
    </div>
</div>

<div class="malla-container">
    <table class="malla-table">
        <thead>
            <tr>
                <th class="empleado-header">Empleado</th>
                {% for fecha in fechas %}
                <th class="fecha-header">
                    <div class="fecha-dia">{{ fecha.day }}</div>
                    <div class="fecha-mes">{{ fecha|date:"m/y" }}</div>
                    <div class="fecha-dow">{{ fecha|date:"D" }}</div>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for empleado in empleados %}
            <tr>
                <td class="empleado-cell">
                    <div class="empleado-nombre">{{ empleado.nombre_tercero }}</div>
                    <div class="empleado-apellido">{{ empleado.apellido_tercero }}</div>
                    <div class="empleado-cedula">Cédula: {{ empleado.documento|default:"-" }}</div>
                    <div class="empleado-cargo">{{ empleado.cargo_predefinido.nombre|default:"Sin cargo" }}</div>
                </td>
                {% for fecha in fechas %}
                <td class="turno-cell">
                    {% with fecha_str=fecha|date:"Y-m-d" %}
                        {% with letra=matriz_empleados_fechas|dict_get:empleado.id_tercero|dict_get:fecha_str %}
                            <span class="turno-letra turno-{{ letra|default:'vacio' }} editable"
                                  data-letra="{{ letra|default:'-' }}"
                                  data-empleado-id="{{ empleado.id_tercero }}"
                                  data-fecha="{{ fecha_str }}"
                                  title="Doble clic para ir al módulo de asignación de turno"
                                  ondblclick="redirigirEdicion(this)">
                                {{ letra|default:'-' }}
                            </span>
                        {% endwith %}
                    {% endwith %}
                </td>
                {% endfor %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ fechas|length|add:1 }}" style="text-align: center; padding: 2rem;">
                    No hay empleados asignados a esta programación.
                </td>
            </tr>
            {% endfor %}

            <!-- NUEVA FILA DE RESUMEN DIARIO -->
            <tr style="border-top: 3px solid var(--regency-red); background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
                <td class="empleado-cell" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); font-weight: bold; color: var(--regency-red);">
                    <div class="empleado-nombre" style="font-size: 1rem;">📊 RESUMEN DIARIO</div>
                    <div class="empleado-cargo" style="color: #6b7280;">Conteo de turnos por día</div>
                </td>
                {% for fecha in fechas %}
                <td class="turno-cell" style="background: #f8fafc; padding: 0.5rem;">
                    {% with fecha_str=fecha|date:"Y-m-d" %}
                        <div style="display: flex; flex-direction: column; gap: 2px; font-size: 0.75rem; line-height: 1.2;">
                            {% for letra, info in codigos_info.items %}
                                {% with count=conteos_diarios|dict_get:fecha_str|dict_get:letra|default:0 %}
                                    {% if count > 0 %}
                                        <div style="display: flex; align-items: center; gap: 3px; justify-content: center;">
                                            <span class="turno-letra" style="width: 16px; height: 16px; line-height: 16px; font-size: 0.7rem; border-width: 1px;" 
                                                  class="turno-{{ letra }}">{{ letra }}</span>
                                            <span style="font-weight: 600; color: #374151;">{{ count }}</span>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                            
                            <!-- Mostrar total del día -->
                            {% with total_dia=conteos_diarios|dict_get:fecha_str|dict_get:'total'|default:0 %}
                                {% if total_dia > 0 %}
                                    <div style="border-top: 1px solid #d1d5db; padding-top: 2px; margin-top: 2px; font-weight: bold; color: var(--regency-red); font-size: 0.7rem;">
                                        Total: {{ total_dia }}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    {% endwith %}
                </td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
</div>

<!-- Leyenda de Turnos -->
<div style="margin-top: 2rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
    <h3 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.1rem;">Leyenda de Turnos</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
        {% for letra, info in codigos_info.items %}
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="turno-letra turno-{{ letra }}">{{ letra }}</span>
            <div>
                <div style="font-size: 0.9rem; color: #374151; font-weight: 500;">{{ info.descripcion }}</div>
                <div style="font-size: 0.8rem; color: #6b7280;">{{ info.duracion }}h | {{ info.tipo }}</div>
            </div>
        </div>
        {% endfor %}
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="turno-letra turno-vacio">-</span>
            <div>
                <div style="font-size: 0.9rem; color: #374151; font-weight: 500;">Sin asignación</div>
                <div style="font-size: 0.8rem; color: #6b7280;">Sin turno asignado</div>
            </div>
        </div>
    </div>
</div>

<!-- Instrucción de uso -->
<div style="margin-top: 1rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem;">
    <h4 style="margin: 0 0 0.5rem 0; color: #0c4a6e; font-size: 1rem;">💡 Instrucción:</h4>
    <ul style="margin: 0; padding-left: 1.5rem; color: #0c4a6e; font-size: 0.9rem;">
        <li><strong>Doble clic</strong> en cualquier letra de turno para ir al módulo de asignación de turno</li>
    </ul>
</div>

<!-- DEBUG INFO -->
{% if debug %}
<div style="margin-top: 2rem; background: #f0f0f0; border: 1px solid #ccc; padding: 1rem; font-family: monospace; font-size: 12px;">
    <h4>DEBUG INFO:</h4>
    <p><strong>Total empleados:</strong> {{ empleados|length }}</p>
    <p><strong>Total fechas:</strong> {{ fechas|length }}</p>
    <p><strong>Total asignaciones en matriz:</strong> {{ matriz_turnos|length }}</p>
    <p><strong>Letras válidas disponibles:</strong> {{ letras_validas|join:", " }}</p>
    <p><strong>Primeras 5 claves en matriz_turnos:</strong></p>
    <ul>
    {% for key, value in matriz_turnos.items|slice:":5" %}
        <li>{{ key }} = {{ value }}</li>
    {% endfor %}
    </ul>
    <p><strong>Codigos_info disponible:</strong> {{ codigos_info|yesno:"Sí,No" }}</p>
    {% if codigos_info %}
    <p><strong>Letras en codigos_info:</strong> {{ codigos_info.keys|join:", " }}</p>
    {% endif %}
</div>
{% endif %}


<script src="{% static 'malla/js/malla_turno.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inicioInput = document.getElementById('fecha_inicio');
    const finInput = document.getElementById('fecha_fin');
    const form = document.getElementById('filtro-fechas-malla');
    const programacionId = "{{ programacion.id }}"; // Django variable

    // Claves únicas por malla
    const keyInicio = `malla_fecha_inicio_${programacionId}`;
    const keyFin = `malla_fecha_fin_${programacionId}`;

    let fechaInicioLS = localStorage.getItem(keyInicio);
    let fechaFinLS = localStorage.getItem(keyFin);

    // Solo redirigir si los parámetros NO están en la URL
    const params = new URLSearchParams(window.location.search);
    const urlTieneInicio = params.has('fecha_inicio');
    const urlTieneFin = params.has('fecha_fin');

    if (fechaInicioLS && fechaFinLS && !urlTieneInicio && !urlTieneFin) {
        params.set('fecha_inicio', fechaInicioLS);
        params.set('fecha_fin', fechaFinLS);
        window.location.search = params.toString();
        return;
    }

    // Guardar al cambiar
    inicioInput.addEventListener('change', () => {
        localStorage.setItem(keyInicio, inicioInput.value);
    });
    finInput.addEventListener('change', () => {
        localStorage.setItem(keyFin, finInput.value);
    });

    // Guardar al enviar el formulario
    form.addEventListener('submit', function() {
        localStorage.setItem(keyInicio, inicioInput.value);
        localStorage.setItem(keyFin, finInput.value);
    });
});
</script>
{% endblock %}

