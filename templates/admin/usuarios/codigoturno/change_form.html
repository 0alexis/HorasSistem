{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
/* Estilos inline para la interfaz de c√≥digos de turno */
.segmentos-container {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
}

.segmento-item {
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 10px;
    margin: 8px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.segmento-item:hover {
    border-color: #007cba;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.segmento-numero {
    background: #007cba;
    color: white;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
}

.segmento-campos {
    display: flex;
    gap: 10px;
    flex: 1;
    align-items: center;
}

.segmento-campos input,
.segmento-campos select {
    padding: 5px 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 14px;
}

.segmento-campos input[type="time"] {
    width: 100px;
}

.segmento-campos select {
    width: 120px;
}

.segmento-acciones {
    display: flex;
    gap: 5px;
}

.btn-segmento {
    background: #007cba;
    color: white;
    border: none;
    border-radius: 3px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
}

.btn-segmento:hover {
    background: #005a87;
}

.btn-segmento.danger {
    background: #dc3545;
}

.btn-segmento.danger:hover {
    background: #c82333;
}

.btn-segmento.success {
    background: #28a745;
}

.btn-segmento.success:hover {
    background: #218838;
}

.controles-segmentos {
    margin: 15px 0;
    padding: 10px;
    background: #e9ecef;
    border-radius: 4px;
}

.controles-segmentos button {
    margin-right: 10px;
}

.tipo-turno-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 4px;
    padding: 10px;
    margin: 10px 0;
    color: #0c5460;
}

.tipo-turno-info.warning {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.tipo-turno-info.error {
    background: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.duracion-counter {
    background: #28a745;
    color: white;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 10px 0;
    font-weight: bold;
    text-align: center;
    font-size: 16px;
}

.duracion-counter.warning {
    background: #ffc107;
    color: #212529;
}

.duracion-counter.error {
    background: #dc3545;
}

.segmentos-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.segmentos-table th,
.segmentos-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.segmentos-table th {
    background: #f2f2f2;
    font-weight: bold;
}

.segmentos-table tr:nth-child(even) {
    background: #f9f9f9;
}

.segmentos-table tr:hover {
    background: #f0f0f0;
}

.segmentos-info {
    margin: 15px 0;
}

.segmentos-info h4 {
    margin-bottom: 10px;
    color: #333;
}
</style>

<script>
/**
 * JavaScript para la interfaz de c√≥digos de turno
 */

(function($) {
    'use strict';
    
    // Configuraci√≥n
    const SEGMENTO_TIPOS = [
        ['NORMAL', 'Normal'],
        ['FESTIVO', 'Festivo'],
        ['NOCTURNO', 'Nocturno'],
        ['DOMINGO', 'Domingo'],
        ['EXTRA', 'Extra'],
        ['COMPENSATORIO', 'Compensatorio']
    ];
    
    // Plantillas predefinidas
    const PLANTILLAS = {
        'N': { // Normal
            nombre: 'Turno Normal',
            segmentos: [
                {inicio: '08:00', fin: '16:00', tipo: 'NORMAL'}
            ]
        },
        'F': { // Festivo
            nombre: 'Turno Festivo Est√°ndar',
            segmentos: [
                {inicio: '08:00', fin: '12:00', tipo: 'NORMAL'},
                {inicio: '12:00', fin: '16:00', tipo: 'FESTIVO'}
            ]
        },
        'FO': { // Festivo Ordinario
            nombre: 'Turno Festivo Ordinario',
            segmentos: [
                {inicio: '08:00', fin: '12:00', tipo: 'NORMAL'},
                {inicio: '12:00', fin: '16:00', tipo: 'FESTIVO'}
            ]
        },
        'E': { // Especial
            nombre: 'Turno Especial',
            segmentos: [
                {inicio: '06:00', fin: '08:00', tipo: 'NOCTURNO'},
                {inicio: '08:00', fin: '12:00', tipo: 'NORMAL'},
                {inicio: '12:00', fin: '16:00', tipo: 'FESTIVO'}
            ]
        }
    };
    
    class CodigoTurnoAdmin {
        constructor() {
            this.segmentos = [];
            this.tipoTurno = null;
            this.init();
        }
        
        init() {
            this.bindEvents();
            this.cargarSegmentosExistentes();
            this.actualizarInterfaz();
        }
        
        bindEvents() {
            // Cambio de tipo de turno
            $('#id_tipo').on('change', (e) => {
                this.tipoTurno = $(e.target).val();
                this.actualizarInterfaz();
            });
            
            // Botones de control
            $(document).on('click', '.btn-agregar-segmento', (e) => {
                e.preventDefault();
                this.agregarSegmento();
            });
            
            $(document).on('click', '.btn-eliminar-segmento', (e) => {
                e.preventDefault();
                const index = $(e.target).data('index');
                this.eliminarSegmento(index);
            });
            
            $(document).on('click', '.btn-plantilla', (e) => {
                e.preventDefault();
                const plantilla = $(e.target).data('plantilla');
                this.aplicarPlantilla(plantilla);
            });
            
            // Validaci√≥n en tiempo real
            $(document).on('change', '.segmento-campos input, .segmento-campos select', () => {
                this.validarSegmentos();
            });
        }
        
        cargarSegmentosExistentes() {
            const segmentosJson = $('#id_segmentos_json').val();
            if (segmentosJson) {
                try {
                    this.segmentos = JSON.parse(segmentosJson);
                } catch (e) {
                    console.error('Error al cargar segmentos:', e);
                    this.segmentos = [];
                }
            }
        }
        
        actualizarInterfaz() {
            const tipo = $('#id_tipo').val();
            
            // Ocultar/mostrar campos seg√∫n el tipo
            if (tipo === 'D' || tipo === 'ND') {
                $('.segmentos-container').hide();
                $('.controles-segmentos').hide();
                this.mostrarInfoTipo(tipo);
            } else {
                $('.segmentos-container').show();
                $('.controles-segmentos').show();
                this.renderizarSegmentos();
                this.mostrarInfoTipo(tipo);
            }
            
            // Mostrar campo de descripci√≥n para No Devengado
            if (tipo === 'ND') {
                $('#id_descripcion_novedad').closest('.form-row').show();
            } else {
                $('#id_descripcion_novedad').closest('.form-row').hide();
            }
        }
        
        mostrarInfoTipo(tipo) {
            let info = '';
            
            switch(tipo) {
                case 'N':
                    info = 'Turno Normal: Debe tener exactamente 1 segmento de tipo NORMAL.';
                    break;
                case 'D':
                    info = 'Turno Descanso: No requiere segmentos ni horarios.';
                    break;
                case 'F':
                case 'FO':
                    info = 'Turno Festivo: Puede tener m√∫ltiples segmentos con diferentes tipos.';
                    break;
                case 'E':
                    info = 'Turno Especial: Configuraci√≥n personalizada con m√∫ltiples segmentos.';
                    break;
                case 'ND':
                    info = 'Turno No Devengado: Requiere descripci√≥n de la novedad.';
                    break;
            }
            
            $('.tipo-turno-info').remove();
            $('.segmentos-container').before(`
                <div class="tipo-turno-info">
                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> ${info}
                </div>
            `);
        }
        
        renderizarSegmentos() {
            const container = $('.segmentos-lista');
            container.empty();
            
            this.segmentos.forEach((segmento, index) => {
                const html = this.crearHTMLSegmento(segmento, index);
                container.append(html);
            });
            
            this.actualizarJSON();
        }
        
        crearHTMLSegmento(segmento, index) {
            const tiposOptions = SEGMENTO_TIPOS.map(([valor, etiqueta]) => 
                `<option value="${valor}" ${segmento.tipo === valor ? 'selected' : ''}>${etiqueta}</option>`
            ).join('');
            
            return `
                <div class="segmento-item" data-index="${index}">
                    <div class="segmento-numero">${index + 1}</div>
                    <div class="segmento-campos">
                        <input type="time" value="${segmento.inicio}" placeholder="Inicio" class="segmento-inicio">
                        <input type="time" value="${segmento.fin}" placeholder="Fin" class="segmento-fin">
                        <select class="segmento-tipo">
                            ${tiposOptions}
                        </select>
                    </div>
                    <div class="segmento-acciones">
                        <button type="button" class="btn-segmento danger btn-eliminar-segmento" data-index="${index}">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
        }
        
        agregarSegmento() {
            if (this.segmentos.length >= 8) {
                alert('M√°ximo 8 segmentos permitidos');
                return;
            }
            
            const nuevoSegmento = {
                inicio: '08:00',
                fin: '16:00',
                tipo: 'NORMAL'
            };
            
            this.segmentos.push(nuevoSegmento);
            this.renderizarSegmentos();
        }
        
        eliminarSegmento(index) {
            if (confirm('¬øEst√°s seguro de eliminar este segmento?')) {
                this.segmentos.splice(index, 1);
                this.renderizarSegmentos();
            }
        }
        
        aplicarPlantilla(plantillaKey) {
            const plantilla = PLANTILLAS[plantillaKey];
            if (plantilla) {
                this.segmentos = [...plantilla.segmentos];
                this.renderizarSegmentos();
                alert(`Plantilla "${plantilla.nombre}" aplicada`);
            }
        }
        
        validarSegmentos() {
            // Recopilar datos actuales
            this.actualizarSegmentosDesdeDOM();
            
            // Validaciones
            const errores = [];
            
            if (this.segmentos.length === 0 && !['D', 'ND'].includes(this.tipoTurno)) {
                errores.push('Debe tener al menos 1 segmento');
            }
            
            if (this.segmentos.length > 8) {
                errores.push('M√°ximo 8 segmentos permitidos');
            }
            
            // Validar continuidad
            for (let i = 0; i < this.segmentos.length - 1; i++) {
                if (this.segmentos[i].fin !== this.segmentos[i + 1].inicio) {
                    errores.push(`Gap detectado entre ${this.segmentos[i].fin} y ${this.segmentos[i + 1].inicio}`);
                }
            }
            
            // Validar tipo Normal
            if (this.tipoTurno === 'N') {
                if (this.segmentos.length !== 1) {
                    errores.push('Los turnos normales deben tener exactamente 1 segmento');
                } else if (this.segmentos[0].tipo !== 'NORMAL') {
                    errores.push('Los turnos normales solo pueden tener segmentos de tipo NORMAL');
                }
            }
            
            // Validar duraci√≥n esperada
            const duracionActual = this.calcularDuracionTotal();
            const duracionError = this.validarDuracionEsperada(duracionActual);
            if (duracionError) {
                errores.push(duracionError);
            }
            
            // Mostrar errores
            this.mostrarErrores(errores);
            
            // Mostrar informaci√≥n de duraci√≥n
            this.mostrarInfoDuracion(duracionActual);
            
            return errores.length === 0;
        }
        
        calcularDuracionTotal() {
            if (this.segmentos.length === 0) return 0;
            
            let duracionTotal = 0;
            
            for (const segmento of this.segmentos) {
                const inicio = this.parseTime(segmento.inicio);
                const fin = this.parseTime(segmento.fin);
                
                let duracion = fin - inicio;
                if (duracion < 0) {
                    duracion += 24; // Si cruza medianoche
                }
                
                duracionTotal += duracion;
            }
            
            return duracionTotal;
        }
        
        parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours + minutes / 60;
        }
        
        validarDuracionEsperada(duracionActual) {
            const duracionesEsperadas = {
                'N': [8, 8],     // Normal: exactamente 8 horas
                'F': [6, 10],    // Festivo: entre 6 y 10 horas
                'FO': [6, 10],   // Festivo Ordinario: entre 6 y 10 horas
                'E': [4, 12],    // Especial: entre 4 y 12 horas
                'D': [0, 0],     // Descanso: 0 horas
                'ND': [0, 0],    // No Devengado: 0 horas
            };
            
            if (!duracionesEsperadas[this.tipoTurno]) return null;
            
            const [min, max] = duracionesEsperadas[this.tipoTurno];
            
            if (min === max) {
                if (Math.abs(duracionActual - min) > 0.1) {
                    return `Los turnos de tipo ${this.getTipoDisplay()} deben tener exactamente ${min} horas. Duraci√≥n actual: ${duracionActual.toFixed(1)} horas`;
                }
            } else {
                if (duracionActual < min || duracionActual > max) {
                    return `Los turnos de tipo ${this.getTipoDisplay()} deben tener entre ${min} y ${max} horas. Duraci√≥n actual: ${duracionActual.toFixed(1)} horas`;
                }
            }
            
            return null;
        }
        
        getTipoDisplay() {
            const tipos = {
                'N': 'Normal',
                'F': 'Festivo',
                'FO': 'Festivo Ordinario',
                'E': 'Especial',
                'D': 'Descanso',
                'ND': 'No Devengado'
            };
            return tipos[this.tipoTurno] || this.tipoTurno;
        }
        
        mostrarInfoDuracion(duracionActual) {
            $('.duracion-info').remove();
            $('.duracion-counter').remove();
            
            const duracionesEsperadas = {
                'N': [8, 8],
                'F': [6, 10],
                'FO': [6, 10],
                'E': [4, 12],
                'D': [0, 0],
                'ND': [0, 0],
            };
            
            // Mostrar contador de duraci√≥n
            const counterHtml = `
                <div class="duracion-counter">
                    <strong>‚è±Ô∏è Duraci√≥n Total:</strong> ${duracionActual.toFixed(1)} horas
                </div>
            `;
            $('.segmentos-container').before(counterHtml);
            
            if (duracionesEsperadas[this.tipoTurno]) {
                const [min, max] = duracionesEsperadas[this.tipoTurno];
                let duracionEsperada = '';
                
                if (min === max) {
                    duracionEsperada = `Exactamente ${min} horas`;
                } else {
                    duracionEsperada = `Entre ${min} y ${max} horas`;
                }
                
                const esValida = min === max ? 
                    Math.abs(duracionActual - min) <= 0.1 :
                    duracionActual >= min && duracionActual <= max;
                
                const color = esValida ? 'green' : 'red';
                const icono = esValida ? '‚úÖ' : '‚ùå';
                
                const infoHtml = `
                    <div class="duracion-info tipo-turno-info" style="border-left: 4px solid ${color};">
                        <strong>${icono} Duraci√≥n:</strong> ${duracionActual.toFixed(1)} horas / ${duracionEsperada}
                    </div>
                `;
                
                $('.segmentos-container').before(infoHtml);
            }
            
            // Actualizar el campo de duraci√≥n total
            $('#id_duracion_total').val(duracionActual.toFixed(1));
        }
        
        actualizarSegmentosDesdeDOM() {
            this.segmentos = [];
            $('.segmento-item').each((index, elemento) => {
                const $elemento = $(elemento);
                const segmento = {
                    inicio: $elemento.find('.segmento-inicio').val(),
                    fin: $elemento.find('.segmento-fin').val(),
                    tipo: $elemento.find('.segmento-tipo').val()
                };
                this.segmentos.push(segmento);
            });
        }
        
        mostrarErrores(errores) {
            $('.segmentos-error').remove();
            
            if (errores.length > 0) {
                const errorHtml = `
                    <div class="segmentos-error tipo-turno-info error">
                        <strong>‚ö†Ô∏è Errores de validaci√≥n:</strong>
                        <ul>
                            ${errores.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
                $('.segmentos-container').before(errorHtml);
            }
        }
        
        actualizarJSON() {
            $('#id_segmentos_json').val(JSON.stringify(this.segmentos));
            
            // Tambi√©n actualizar la duraci√≥n total
            const duracionActual = this.calcularDuracionTotal();
            $('#id_duracion_total').val(duracionActual.toFixed(1));
        }
    }
    
    // Inicializar cuando el DOM est√© listo
    $(document).ready(function() {
        // Agregar controles de segmentos si no existen
        if ($('.segmentos-container').length === 0) {
            const controlesHTML = `
                <div class="segmentos-container">
                    <h4>Configuraci√≥n de Segmentos</h4>
                    <div class="controles-segmentos">
                        <button type="button" class="btn-segmento success btn-agregar-segmento">
                            ‚ûï Agregar Segmento
                        </button>
                        <button type="button" class="btn-segmento btn-plantilla" data-plantilla="N">
                            üìã Normal
                        </button>
                        <button type="button" class="btn-segmento btn-plantilla" data-plantilla="F">
                            üìã Festivo
                        </button>
                        <button type="button" class="btn-segmento btn-plantilla" data-plantilla="E">
                            üìã Especial
                        </button>
                    </div>
                    <div class="segmentos-lista"></div>
                </div>
            `;
            
            $('#id_segmentos_json').closest('.form-row').after(controlesHTML);
        }
        
        // Inicializar la interfaz
        new CodigoTurnoAdmin();
    });
    
})(django.jQuery);
</script>
{% endblock %}