{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
/* Estilos inline para la interfaz de códigos de turno */
.segmentos-container {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
}

.segmento-item {
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 10px;
    margin: 8px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.segmento-item:hover {
    border-color: #007cba;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.segmento-numero {
    background: #007cba;
    color: white;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
}

.segmento-campos {
    display: flex;
    gap: 10px;
    flex: 1;
    align-items: center;
}

.segmento-campos input,
.segmento-campos select {
    padding: 5px 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 14px;
}

.segmento-campos input[type="time"] {
    width: 100px;
    /* Forzar formato de 24 horas */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

/* Estilos específicos para formato de 24 horas */
.segmento-campos input[type="time"]::-webkit-datetime-edit-hour-field,
.segmento-campos input[type="time"]::-webkit-datetime-edit-minute-field {
    /* Asegurar que se muestre en formato de 24 horas */
    -webkit-appearance: none;
}

/* Ocultar indicadores AM/PM si el navegador los muestra */
.segmento-campos input[type="time"]::-webkit-datetime-edit-ampm-field {
    display: none;
}

/* Estilos adicionales para forzar formato de 24 horas */
input[type="time"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    text-align: center;
}

input[type="time"]::-webkit-datetime-edit {
    text-align: center;
}

input[type="time"]::-webkit-datetime-edit-hour-field,
input[type="time"]::-webkit-datetime-edit-minute-field {
    -webkit-appearance: none;
    text-align: center;
}

input[type="time"]::-webkit-datetime-edit-ampm-field {
    display: none !important;
}

input[type="time"]::-moz-datetime-edit-ampm-field {
    display: none !important;
}

/* Para Firefox */
input[type="time"]::-moz-datetime-edit {
    text-align: center;
}

/* Para Edge */
input[type="time"]::-ms-datetime-edit {
    text-align: center;
}

.segmento-campos select {
    width: 120px;
}

.segmento-acciones {
    display: flex;
    gap: 5px;
}

.btn-segmento {
    background: #007cba;
    color: white;
    border: none;
    border-radius: 3px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 12px;
}

.btn-segmento:hover {
    background: #005a87;
}

.btn-segmento.danger {
    background: #dc3545;
}

.btn-segmento.danger:hover {
    background: #c82333;
}

.btn-segmento.success {
    background: #28a745;
}

.btn-segmento.success:hover {
    background: #218838;
}

.controles-segmentos {
    margin: 15px 0;
    padding: 10px;
    background: #e9ecef;
    border-radius: 4px;
}

.controles-segmentos button {
    margin-right: 10px;
}

.tipo-turno-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 4px;
    padding: 10px;
    margin: 10px 0;
    color: #0c5460;
}

.tipo-turno-info.warning {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.tipo-turno-info.error {
    background: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.duracion-counter {
    background: #28a745;
    color: white;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 10px 0;
    font-weight: bold;
    text-align: center;
    font-size: 16px;
}

.duracion-counter.warning {
    background: #ffc107;
    color: #212529;
}

.duracion-counter.error {
    background: #dc3545;
}

.segmentos-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

.segmentos-table th,
.segmentos-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.segmentos-table th {
    background: #f2f2f2;
    font-weight: bold;
}

.segmentos-table tr:nth-child(even) {
    background: #f9f9f9;
}

.segmentos-table tr:hover {
    background: #f0f0f0;
}

.segmentos-info {
    margin: 15px 0;
}

.segmentos-info h4 {
    margin-bottom: 10px;
    color: #333;
}

/* Estilos específicos para el widget TimeInput24Hours */
.time-input-24h {
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    text-align: center !important;
}

.time-input-24h::-webkit-datetime-edit {
    text-align: center !important;
}

.time-input-24h::-webkit-datetime-edit-hour-field,
.time-input-24h::-webkit-datetime-edit-minute-field {
    -webkit-appearance: none !important;
    text-align: center !important;
}

.time-input-24h::-webkit-datetime-edit-ampm-field {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    position: absolute !important;
    left: -9999px !important;
}

.time-input-24h::-moz-datetime-edit-ampm-field {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    position: absolute !important;
    left: -9999px !important;
}

.time-input-24h::-ms-datetime-edit-ampm-field {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    position: absolute !important;
    left: -9999px !important;
}

/* Estilos adicionales para forzar formato de 24 horas */
input[type="time"] {
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    text-align: center !important;
}

input[type="time"]::-webkit-datetime-edit {
    text-align: center !important;
}

input[type="time"]::-webkit-datetime-edit-hour-field,
input[type="time"]::-webkit-datetime-edit-minute-field {
    -webkit-appearance: none !important;
    text-align: center !important;
}

input[type="time"]::-webkit-datetime-edit-ampm-field {
    display: none !important;
}

input[type="time"]::-moz-datetime-edit-ampm-field {
    display: none !important;
}

/* Para Firefox */
input[type="time"]::-moz-datetime-edit {
    text-align: center;
}

/* Para Edge */
input[type="time"]::-ms-datetime-edit {
    text-align: center;
}
</style>

<script>
/**
 * JavaScript para la interfaz de códigos de turno
 */

(function($) {
    'use strict';
    
    // Configuración
    const SEGMENTO_TIPOS = [
        ['NORMAL', 'Normal'],
        ['FESTIVO', 'Festivo'],
        ['NOCTURNO', 'Nocturno'],
        ['DOMINGO', 'Domingo'],
        ['EXTRA', 'Extra'],
        ['COMPENSATORIO', 'Compensatorio']
    ];
    
    // Plantillas predefinidas (sin valores de tiempo predeterminados)
    const PLANTILLAS = {
        'N': { // Normal
            nombre: 'Turno Normal',
            segmentos: [
                {inicio: '', fin: '', tipo: 'NORMAL'}
            ]
        },
        'F': { // Festivo
            nombre: 'Turno Festivo Estándar',
            segmentos: [
                {inicio: '', fin: '', tipo: 'NORMAL'},
                {inicio: '', fin: '', tipo: 'FESTIVO'}
            ]
        },
        'FO': { // Festivo Ordinario
            nombre: 'Turno Festivo Ordinario',
            segmentos: [
                {inicio: '', fin: '', tipo: 'NORMAL'},
                {inicio: '', fin: '', tipo: 'FESTIVO'}
            ]
        },
        'E': { // Especial
            nombre: 'Turno Especial',
            segmentos: [
                {inicio: '', fin: '', tipo: 'NOCTURNO'},
                {inicio: '', fin: '', tipo: 'NORMAL'},
                {inicio: '', fin: '', tipo: 'FESTIVO'}
            ]
        }
    };
    
    class CodigoTurnoAdmin {
        constructor() {
            this.segmentos = [];
            this.tipoTurno = null;
            this.init();
        }
        
        init() {
            this.bindEvents();
            this.cargarSegmentosExistentes();
            this.actualizarInterfaz();
            // Forzar formato de 24 horas al inicializar
            setTimeout(() => {
                this.forzarFormato24Horas();
                this.inicializarFormato24Horas();
            }, 100);
        }
        
        inicializarFormato24Horas() {
            // Observar cambios en el DOM para aplicar formato de 24 horas a nuevos inputs
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) { // Element node
                                const timeInputs = node.querySelectorAll ? node.querySelectorAll('input[type="time"]') : [];
                                if (node.matches && node.matches('input[type="time"]')) {
                                    timeInputs.push(node);
                                }
                                
                                timeInputs.forEach(input => {
                                    input.setAttribute('step', '900');
                                    input.setAttribute('data-format', '24');
                                    input.setAttribute('min', '00:00');
                                    input.setAttribute('max', '23:59');
                                    input.classList.add('time-input-24h');
                                    
                                    // Agregar eventos para mantener formato de 24 horas
                                    input.addEventListener('click', function() {
                                        this.setAttribute('data-format', '24');
                                        this.setAttribute('step', '900');
                                        this.setAttribute('min', '00:00');
                                        this.setAttribute('max', '23:59');
                                        this.classList.add('time-input-24h');
                                        setTimeout(() => {
                                            this.forzarFormato24HorasNativo(this);
                                            this.eliminarBotonesAMPM();
                                            this.forzarRango24Horas();
                                        }, 10);
                                    });
                                    
                                    input.addEventListener('focus', function() {
                                        this.setAttribute('data-format', '24');
                                        this.setAttribute('step', '900');
                                        this.setAttribute('min', '00:00');
                                        this.setAttribute('max', '23:59');
                                        this.classList.add('time-input-24h');
                                        setTimeout(() => {
                                            this.forzarFormato24HorasNativo(this);
                                            this.eliminarBotonesAMPM();
                                            this.forzarRango24Horas();
                                        }, 10);
                                    });
                                    
                                    // Forzar formato inmediatamente
                                    setTimeout(() => {
                                        this.forzarFormato24HorasNativo(input);
                                        this.eliminarBotonesAMPM();
                                        this.forzarRango24Horas();
                                    }, 50);
                                });
                            }
                        });
                    }
                });
            });
            
            // Observar cambios en el documento
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Aplicar formato de 24 horas a todos los inputs existentes
            document.querySelectorAll('input[type="time"]').forEach(input => {
                input.setAttribute('step', '900');
                input.setAttribute('data-format', '24');
                input.setAttribute('min', '00:00');
                input.setAttribute('max', '23:59');
                input.classList.add('time-input-24h');
                
                // Forzar formato inmediatamente
                setTimeout(() => {
                    this.forzarFormato24HorasNativo(input);
                    this.eliminarBotonesAMPM();
                    this.forzarRango24Horas();
                }, 50);
            });
            
            // Agregar estilos CSS adicionales para forzar formato de 24 horas
            if (!$('#time-24h-forced-styles').length) {
                $('head').append(`
                    <style id="time-24h-forced-styles">
                        /* Forzar formato de 24 horas de manera más agresiva */
                        input[type="time"] {
                            -webkit-appearance: none !important;
                            -moz-appearance: none !important;
                            appearance: none !important;
                            text-align: center !important;
                        }
                        
                        /* Ocultar completamente AM/PM en todos los navegadores */
                        input[type="time"]::-webkit-datetime-edit-ampm-field,
                        input[type="time"]::-moz-datetime-edit-ampm-field,
                        input[type="time"]::-ms-datetime-edit-ampm-field {
                            display: none !important;
                            width: 0 !important;
                            height: 0 !important;
                            overflow: hidden !important;
                            opacity: 0 !important;
                            pointer-events: none !important;
                        }
                        
                        /* Asegurar que solo se muestren horas y minutos */
                        input[type="time"]::-webkit-datetime-edit-hour-field,
                        input[type="time"]::-webkit-datetime-edit-minute-field {
                            -webkit-appearance: none !important;
                            text-align: center !important;
                        }
                        
                        input[type="time"]::-moz-datetime-edit-hour-field,
                        input[type="time"]::-moz-datetime-edit-minute-field {
                            text-align: center !important;
                        }
                        
                        /* Forzar rango de 24 horas */
                        input[type="time"] {
                            min: 00:00 !important;
                            max: 23:59 !important;
                        }
                        
                        /* Ocultar elementos del popup que muestren 12 horas */
                        input[type="time"]::-webkit-calendar-picker-indicator {
                            display: none !important;
                        }
                        
                        /* Estilos para el popup del navegador */
                        input[type="time"]::-webkit-datetime-edit {
                            text-align: center !important;
                        }
                    </style>
                `);
            }
            
            // Corregir problema de guardado
            this.corregirProblemaGuardado();
            
            // Interceptar popups del navegador
            this.interceptarPopupsNavegador();
        }
        
        interceptarPopupsNavegador() {
            // Interceptar cuando se abre un popup de tiempo
            document.addEventListener('click', function(e) {
                if (e.target.type === 'time') {
                    setTimeout(() => {
                        // Buscar elementos del popup que muestren 12 horas
                        const popupElementos = document.querySelectorAll('select, option, input[type="number"]');
                        popupElementos.forEach(elemento => {
                            const texto = elemento.textContent || elemento.innerText || '';
                            if (texto.includes('AM') || texto.includes('PM') || 
                                (texto.includes('1') && texto.includes('2') && !texto.includes('13'))) {
                                // Es un elemento de 12 horas, ocultarlo o cambiarlo
                                elemento.style.display = 'none';
                                elemento.style.visibility = 'hidden';
                                elemento.style.opacity = '0';
                                elemento.style.width = '0';
                                elemento.style.height = '0';
                                elemento.style.overflow = 'hidden';
                                elemento.style.pointerEvents = 'none';
                                elemento.style.position = 'absolute';
                                elemento.style.left = '-9999px';
                            }
                        });
                    }, 100);
                }
            });
        }
        
        corregirProblemaGuardado() {
            // Asegurar que el formulario se guarde correctamente
            $('form').on('submit', function(e) {
                console.log('🔧 Corrigiendo problema de guardado...');
                
                // Convertir todos los valores de tiempo a formato de 24 horas antes de enviar
                $('input[type="time"]').each(function() {
                    let valor = $(this).val();
                    console.log('⏰ Valor original:', valor);
                    
                    if (valor) {
                        // Asegurar que el valor esté en formato de 24 horas
                        if (valor.includes('AM') || valor.includes('PM')) {
                            valor = this.convertirA24Horas(valor);
                            console.log('🔄 Convertido a 24h:', valor);
                        }
                        
                        // Validar formato de 24 horas
                        const [horas, minutos] = valor.split(':');
                        const horaNum = parseInt(horas);
                        const minutoNum = parseInt(minutos);
                        
                        if (horaNum >= 0 && horaNum <= 23 && minutoNum >= 0 && minutoNum <= 59) {
                            // Formato correcto, asegurar que esté en formato HH:MM
                            valor = `${horaNum.toString().padStart(2, '0')}:${minutoNum.toString().padStart(2, '0')}`;
                            $(this).val(valor);
                            console.log('✅ Valor final:', valor);
                        } else {
                            console.error('❌ Formato de hora inválido:', valor);
                        }
                    }
                });
                
                // Asegurar que el campo segmentos_horas tenga el valor correcto
                const segmentosJSON = $('#id_segmentos_horas');
                if (segmentosJSON.length > 0) {
                    // Actualizar segmentos desde el DOM antes de guardar
                    this.actualizarSegmentosDesdeDOM();
                    
                    // Validar y corregir cada segmento
                    this.segmentos.forEach((segmento, index) => {
                        console.log(`📋 Segmento ${index + 1} antes:`, segmento);
                        
                        // Asegurar que inicio y fin estén en formato de 24 horas
                        if (segmento.inicio) {
                            const [horasInicio, minutosInicio] = segmento.inicio.split(':');
                            const horaInicioNum = parseInt(horasInicio);
                            const minutoInicioNum = parseInt(minutosInicio);
                            
                            if (horaInicioNum >= 0 && horaInicioNum <= 23 && minutoInicioNum >= 0 && minutoInicioNum <= 59) {
                                segmento.inicio = `${horaInicioNum.toString().padStart(2, '0')}:${minutoInicioNum.toString().padStart(2, '0')}`;
                            }
                        }
                        
                        if (segmento.fin) {
                            const [horasFin, minutosFin] = segmento.fin.split(':');
                            const horaFinNum = parseInt(horasFin);
                            const minutoFinNum = parseInt(minutosFin);
                            
                            if (horaFinNum >= 0 && horaFinNum <= 23 && minutoFinNum >= 0 && minutoFinNum <= 59) {
                                segmento.fin = `${horaFinNum.toString().padStart(2, '0')}:${minutoFinNum.toString().padStart(2, '0')}`;
                            }
                        }
                        
                        console.log(`📋 Segmento ${index + 1} después:`, segmento);
                    });
                    
                    // Guardar el JSON corregido
                    segmentosJSON.val(JSON.stringify(this.segmentos));
                    console.log('💾 JSON guardado:', segmentosJSON.val());
                }
                
                // Asegurar que la duración total se calcule correctamente
                const duracionTotal = this.calcularDuracionTotal();
                $('#id_duracion_total').val(duracionTotal.toFixed(1));
                console.log('⏱️ Duración total:', duracionTotal);
                
                console.log('✅ Problema de guardado corregido');
            });
        }
        
        bindEvents() {
            // Cambio de tipo de turno
            $('#id_tipo').on('change', (e) => {
                this.tipoTurno = $(e.target).val();
                this.actualizarInterfaz();
            });
            
            // Botones de control
            $(document).on('click', '.btn-agregar-segmento', (e) => {
                e.preventDefault();
                this.agregarSegmento();
            });
            
            $(document).on('click', '.btn-eliminar-segmento', (e) => {
                e.preventDefault();
                const index = $(e.target).data('index');
                this.eliminarSegmento(index);
            });
            
            $(document).on('click', '.btn-plantilla', (e) => {
                e.preventDefault();
                const plantilla = $(e.target).data('plantilla');
                this.aplicarPlantilla(plantilla);
            });
            
            // Validación en tiempo real
            $(document).on('change', '.segmento-campos input, .segmento-campos select', () => {
                this.validarSegmentos();
            });
        }
        
        cargarSegmentosExistentes() {
            const segmentosHoras = $('#id_segmentos_horas').val();
            if (segmentosHoras) {
                try {
                    this.segmentos = JSON.parse(segmentosHoras);
                } catch (e) {
                    console.error('Error al cargar segmentos:', e);
                    this.segmentos = [];
                }
            }
        }
        
        actualizarInterfaz() {
            const tipo = $('#id_tipo').val();
            
            // Ocultar/mostrar campos según el tipo
            if (tipo === 'D' || tipo === 'ND') {
                $('.segmentos-container').hide();
                $('.controles-segmentos').hide();
                this.mostrarInfoTipo(tipo);
            } else {
                $('.segmentos-container').show();
                $('.controles-segmentos').show();
                this.renderizarSegmentos();
                this.mostrarInfoTipo(tipo);
            }
            
            // Mostrar campo de descripción para No Devengado
            if (tipo === 'ND') {
                $('#id_descripcion_novedad').closest('.form-row').show();
            } else {
                $('#id_descripcion_novedad').closest('.form-row').hide();
            }
        }
        
        mostrarInfoTipo(tipo) {
            let info = '';
            
            switch(tipo) {
                case 'N':
                    info = 'Turno Normal: Debe tener exactamente 1 segmento de tipo NORMAL.';
                    break;
                case 'D':
                    info = 'Turno Descanso: No requiere segmentos ni horarios.';
                    break;
                case 'F':
                case 'FO':
                    info = 'Turno Festivo: Puede tener múltiples segmentos con diferentes tipos.';
                    break;
                case 'E':
                    info = 'Turno Especial: Configuración personalizada con múltiples segmentos.';
                    break;
                case 'ND':
                    info = 'Turno No Devengado: Requiere descripción de la novedad.';
                    break;
            }
            
            $('.tipo-turno-info').remove();
            $('.segmentos-container').before(`
                <div class="tipo-turno-info">
                    <strong>ℹ️ Información:</strong> ${info}
                </div>
            `);
        }
        
        renderizarSegmentos() {
            const container = $('.segmentos-lista');
            container.empty();
            
            this.segmentos.forEach((segmento, index) => {
                const html = this.crearHTMLSegmento(segmento, index);
                container.append(html);
            });
            
            // Forzar formato de 24 horas en los inputs de tiempo
            this.forzarFormato24Horas();
            
            this.actualizarJSON();
        }
        
        forzarFormato24Horas() {
            // Configurar todos los inputs de tiempo para usar formato de 24 horas
            $('input[type="time"]').each(function() {
                const input = $(this);
                input.attr('step', '900'); // 15 minutos
                input.attr('data-format', '24');
                input.addClass('time-input-24h');
                
                // Forzar formato de 24 horas de manera más agresiva
                input.attr('min', '00:00');
                input.attr('max', '23:59');
                
                // Asegurar que el valor esté en formato de 24 horas
                let valor = input.val();
                if (valor) {
                    // Convertir de formato 12 horas a 24 horas si es necesario
                    if (valor.includes('AM') || valor.includes('PM')) {
                        valor = this.convertirA24Horas(valor);
                        input.val(valor);
                    }
                }
                
                // Agregar evento para mantener formato de 24 horas
                input.on('change', function() {
                    let nuevoValor = $(this).val();
                    if (nuevoValor && (nuevoValor.includes('AM') || nuevoValor.includes('PM'))) {
                        nuevoValor = this.convertirA24Horas(nuevoValor);
                        $(this).val(nuevoValor);
                    }
                });
                
                // Forzar formato de 24 horas al hacer clic
                input.on('click', function() {
                    this.setAttribute('data-format', '24');
                    this.setAttribute('step', '900');
                    this.setAttribute('min', '00:00');
                    this.setAttribute('max', '23:59');
                    this.classList.add('time-input-24h');
                    
                    setTimeout(() => {
                        this.forzarFormato24HorasNativo(this);
                        this.eliminarBotonesAMPM();
                    }, 10);
                });
                
                // Forzar formato de 24 horas al enfocar
                input.on('focus', function() {
                    this.setAttribute('data-format', '24');
                    this.setAttribute('step', '900');
                    this.setAttribute('min', '00:00');
                    this.setAttribute('max', '23:59');
                    this.classList.add('time-input-24h');
                    
                    setTimeout(() => {
                        this.forzarFormato24HorasNativo(this);
                        this.eliminarBotonesAMPM();
                    }, 10);
                });
                
                // Forzar formato de 24 horas al mostrar
                input.on('show', function() {
                    this.setAttribute('data-format', '24');
                    this.setAttribute('step', '900');
                    this.setAttribute('min', '00:00');
                    this.setAttribute('max', '23:59');
                    this.classList.add('time-input-24h');
                });
            });
            
            // Agregar estilos CSS para forzar formato de 24 horas
            if (!$('#time-24h-styles').length) {
                $('head').append(`
                    <style id="time-24h-styles">
                        input[type="time"] {
                            -webkit-appearance: none;
                            -moz-appearance: none;
                            appearance: none;
                        }
                        
                        input[type="time"]::-webkit-datetime-edit-hour-field,
                        input[type="time"]::-webkit-datetime-edit-minute-field {
                            -webkit-appearance: none;
                        }
                        
                        input[type="time"]::-webkit-datetime-edit-ampm-field {
                            display: none !important;
                        }
                        
                        input[type="time"]::-moz-datetime-edit-ampm-field {
                            display: none !important;
                        }
                        
                        /* Forzar formato de 24 horas en todos los navegadores */
                        input[type="time"] {
                            text-align: center;
                        }
                        
                        /* Ocultar completamente los indicadores AM/PM */
                        input[type="time"]::-webkit-datetime-edit-ampm-field,
                        input[type="time"]::-moz-datetime-edit-ampm-field,
                        input[type="time"]::-ms-datetime-edit-ampm-field {
                            display: none !important;
                            width: 0 !important;
                            height: 0 !important;
                            overflow: hidden !important;
                        }
                        
                        /* Ocultar botones AM/PM en el popup del navegador */
                        input[type="time"]::-webkit-calendar-picker-indicator {
                            display: none !important;
                        }
                        
                        /* Forzar formato de 24 horas en el popup nativo */
                        input[type="time"]::-webkit-datetime-edit {
                            text-align: center !important;
                        }
                        
                        /* Ocultar cualquier elemento AM/PM que pueda aparecer */
                        input[type="time"] *[data-ampm],
                        input[type="time"] *[class*="ampm"],
                        input[type="time"] *[class*="AM"],
                        input[type="time"] *[class*="PM"] {
                            display: none !important;
                            visibility: hidden !important;
                            opacity: 0 !important;
                            width: 0 !important;
                            height: 0 !important;
                        }
                        
                        /* Estilos específicos para Chrome */
                        input[type="time"]::-webkit-datetime-edit-ampm-field {
                            display: none !important;
                            width: 0 !important;
                            height: 0 !important;
                            overflow: hidden !important;
                            opacity: 0 !important;
                            pointer-events: none !important;
                            position: absolute !important;
                            left: -9999px !important;
                        }
                        
                        /* Estilos específicos para Firefox */
                        input[type="time"]::-moz-datetime-edit-ampm-field {
                            display: none !important;
                            width: 0 !important;
                            height: 0 !important;
                            overflow: hidden !important;
                            opacity: 0 !important;
                            pointer-events: none !important;
                            position: absolute !important;
                            left: -9999px !important;
                        }
                        
                        /* Estilos específicos para Edge */
                        input[type="time"]::-ms-datetime-edit-ampm-field {
                            display: none !important;
                            width: 0 !important;
                            height: 0 !important;
                            overflow: hidden !important;
                            opacity: 0 !important;
                            pointer-events: none !important;
                            position: absolute !important;
                            left: -9999px !important;
                        }
                        
                        /* Forzar rango de 24 horas */
                        input[type="time"] {
                            min: 00:00 !important;
                            max: 23:59 !important;
                        }
                    </style>
                `);
            }
        }
        
        forzarFormato24HorasNativo(elemento) {
            // Intentar forzar formato de 24 horas usando diferentes métodos
            try {
                // Método 1: Establecer atributos
                elemento.setAttribute('step', '900');
                elemento.setAttribute('data-format', '24');
                elemento.setAttribute('min', '00:00');
                elemento.setAttribute('max', '23:59');
                
                // Método 2: Simular entrada de teclado para forzar formato
                const valor = elemento.value;
                if (valor) {
                    const [horas, minutos] = valor.split(':');
                    const hora24 = parseInt(horas);
                    if (hora24 >= 0 && hora24 <= 23) {
                        elemento.value = `${hora24.toString().padStart(2, '0')}:${minutos}`;
                    }
                }
                
                // Método 3: Agregar evento para interceptar cambios
                elemento.addEventListener('input', function(e) {
                    let valor = this.value;
                    if (valor && valor.includes('AM') || valor.includes('PM')) {
                        valor = this.convertirA24Horas(valor);
                        this.value = valor;
                    }
                });
                
                // Método 4: Interceptar y eliminar botones AM/PM del popup
                elemento.addEventListener('click', function() {
                    setTimeout(() => {
                        this.eliminarBotonesAMPM();
                        this.forzarRango24Horas();
                    }, 100);
                });
                
                elemento.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.eliminarBotonesAMPM();
                        this.forzarRango24Horas();
                    }, 100);
                });
                
                // Método 5: Forzar rango de 24 horas
                this.forzarRango24Horas();
                
            } catch (error) {
                console.log('Error al forzar formato 24h:', error);
            }
        }
        
        forzarRango24Horas() {
            // Buscar y modificar elementos del popup para forzar rango de 24 horas
            const elementosHora = document.querySelectorAll('input[type="number"], select, option');
            elementosHora.forEach(elemento => {
                const texto = elemento.textContent || elemento.innerText || '';
                const valor = elemento.value || '';
                
                // Si es un selector de hora y tiene valores de 12 horas, cambiarlos a 24
                if (texto.includes('1') && texto.includes('2') && !texto.includes('13')) {
                    // Es un selector de 12 horas, cambiarlo a 24 horas
                    if (elemento.tagName === 'SELECT') {
                        // Reemplazar opciones de 12 horas con 24 horas
                        const opciones = elemento.querySelectorAll('option');
                        opciones.forEach(opcion => {
                            const valorOp = opcion.value || opcion.textContent;
                            if (valorOp && valorOp.includes('1') && !valorOp.includes('13')) {
                                // Cambiar de 12 horas a 24 horas
                                const hora12 = parseInt(valorOp);
                                if (hora12 >= 1 && hora12 <= 12) {
                                    const hora24 = hora12 === 12 ? 12 : hora12;
                                    opcion.value = hora24.toString().padStart(2, '0');
                                    opcion.textContent = hora24.toString().padStart(2, '0');
                                }
                            }
                        });
                    }
                }
            });
            
            // Buscar elementos específicos del popup de tiempo
            const popupElementos = document.querySelectorAll('[class*="time"], [class*="hour"], [class*="minute"]');
            popupElementos.forEach(elemento => {
                const texto = elemento.textContent || elemento.innerText || '';
                if (texto.includes('AM') || texto.includes('PM')) {
                    elemento.style.display = 'none';
                    elemento.style.visibility = 'hidden';
                    elemento.style.opacity = '0';
                    elemento.style.width = '0';
                    elemento.style.height = '0';
                    elemento.style.overflow = 'hidden';
                    elemento.style.pointerEvents = 'none';
                    elemento.style.position = 'absolute';
                    elemento.style.left = '-9999px';
                }
            });
        }
        
        eliminarBotonesAMPM() {
            // Buscar y eliminar botones AM/PM en el DOM
            const elementosAMPM = document.querySelectorAll('[data-ampm], [class*="ampm"], [class*="AM"], [class*="PM"], [textContent*="AM"], [textContent*="PM"]');
            elementosAMPM.forEach(elemento => {
                elemento.style.display = 'none';
                elemento.style.visibility = 'hidden';
                elemento.style.opacity = '0';
                elemento.style.width = '0';
                elemento.style.height = '0';
                elemento.style.overflow = 'hidden';
                elemento.style.pointerEvents = 'none';
                elemento.style.position = 'absolute';
                elemento.style.left = '-9999px';
            });
            
            // Buscar en el popup del navegador
            const popups = document.querySelectorAll('input[type="time"]');
            popups.forEach(input => {
                const popup = input.parentElement;
                if (popup) {
                    const botonesAMPM = popup.querySelectorAll('button, span, div');
                    botonesAMPM.forEach(boton => {
                        const texto = boton.textContent || boton.innerText || '';
                        if (texto.includes('AM') || texto.includes('PM') || texto.includes('a.m.') || texto.includes('p.m.')) {
                            boton.style.display = 'none';
                            boton.style.visibility = 'hidden';
                            boton.style.opacity = '0';
                            boton.style.width = '0';
                            boton.style.height = '0';
                            boton.style.overflow = 'hidden';
                            boton.style.pointerEvents = 'none';
                            boton.style.position = 'absolute';
                            boton.style.left = '-9999px';
                        }
                    });
                }
            });
        }
        
        convertirA24Horas(tiempo12h) {
            // Convertir formato 12 horas a 24 horas
            const [tiempo, periodo] = tiempo12h.split(' ');
            const [horas, minutos] = tiempo.split(':').map(Number);
            
            let horas24 = horas;
            if (periodo === 'PM' && horas !== 12) {
                horas24 = horas + 12;
            } else if (periodo === 'AM' && horas === 12) {
                horas24 = 0;
            }
            
            return `${horas24.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
        }
        
        crearHTMLSegmento(segmento, index) {
            const tiposOptions = SEGMENTO_TIPOS.map(([valor, etiqueta]) => 
                `<option value="${valor}" ${segmento.tipo === valor ? 'selected' : ''}>${etiqueta}</option>`
            ).join('');
            
            // Los inputs de tiempo estarán vacíos por defecto
            let inicio = '';
            let fin = '';
            
            // Solo usar valores si están definidos y no están vacíos
            if (segmento.inicio && segmento.inicio.trim() !== '') {
                inicio = segmento.inicio;
                // Convertir de formato 12 horas a 24 horas si es necesario
                if (inicio.includes('AM') || inicio.includes('PM')) {
                    inicio = this.convertirA24Horas(inicio);
                }
                
                // Validar y corregir formato de 24 horas
                const [horasInicio, minutosInicio] = inicio.split(':');
                const horaInicioNum = parseInt(horasInicio);
                const minutoInicioNum = parseInt(minutosInicio);
                
                if (horaInicioNum >= 0 && horaInicioNum <= 23 && minutoInicioNum >= 0 && minutoInicioNum <= 59) {
                    inicio = `${horaInicioNum.toString().padStart(2, '0')}:${minutoInicioNum.toString().padStart(2, '0')}`;
                } else {
                    inicio = ''; // Si el formato es inválido, dejar vacío
                }
            }
            
            if (segmento.fin && segmento.fin.trim() !== '') {
                fin = segmento.fin;
                // Convertir de formato 12 horas a 24 horas si es necesario
                if (fin.includes('AM') || fin.includes('PM')) {
                    fin = this.convertirA24Horas(fin);
                }
                
                // Validar y corregir formato de 24 horas
                const [horasFin, minutosFin] = fin.split(':');
                const horaFinNum = parseInt(horasFin);
                const minutoFinNum = parseInt(minutosFin);
                
                if (horaFinNum >= 0 && horaFinNum <= 23 && minutoFinNum >= 0 && minutoFinNum <= 59) {
                    fin = `${horaFinNum.toString().padStart(2, '0')}:${minutoFinNum.toString().padStart(2, '0')}`;
                } else {
                    fin = ''; // Si el formato es inválido, dejar vacío
                }
            }
            
            console.log(`📋 Creando segmento ${index + 1}:`, { inicio, fin, tipo: segmento.tipo });
            
            return `
                <div class="segmento-item" data-index="${index}">
                    <div class="segmento-numero">${index + 1}</div>
                    <div class="segmento-campos">
                        <input type="time" 
                               value="${inicio}" 
                               placeholder="Inicio" 
                               class="segmento-inicio time-input-24h" 
                               step="900" 
                               data-format="24"
                               min="00:00"
                               max="23:59"
                               onchange="window.codigoTurnoAdmin.forzarFormatoMilitar(this)">
                        <input type="time" 
                               value="${fin}" 
                               placeholder="Fin" 
                               class="segmento-fin time-input-24h" 
                               step="900" 
                               data-format="24"
                               min="00:00"
                               max="23:59"
                               onchange="window.codigoTurnoAdmin.forzarFormatoMilitar(this)">
                        <select class="segmento-tipo">
                            ${tiposOptions}
                        </select>
                        <button type="button" class="btn-segmento danger btn-eliminar-segmento" data-index="${index}">
                            ❌
                        </button>
                    </div>
                </div>
            `;
        }
        
        agregarSegmento() {
            if (this.segmentos.length >= 8) {
                alert('Máximo 8 segmentos permitidos');
                return;
            }
            
            // Crear segmento con campos vacíos por defecto
            const nuevoSegmento = {
                inicio: '', // Campo vacío por defecto
                fin: '',   // Campo vacío por defecto
                tipo: 'NORMAL'
            };
            
            this.segmentos.push(nuevoSegmento);
            this.renderizarSegmentos();
            console.log('➕ Segmento agregado con campos vacíos:', nuevoSegmento);
        }
        
        eliminarSegmento(index) {
            if (confirm('¿Estás seguro de eliminar este segmento?')) {
                this.segmentos.splice(index, 1);
                this.renderizarSegmentos();
            }
        }
        
        aplicarPlantilla(plantillaKey) {
            const plantilla = PLANTILLAS[plantillaKey];
            if (plantilla) {
                this.segmentos = [...plantilla.segmentos];
                this.renderizarSegmentos();
                alert(`Plantilla "${plantilla.nombre}" aplicada`);
            }
        }
        
        validarSegmentos() {
            // Recopilar datos actuales
            this.actualizarSegmentosDesdeDOM();
            
            // Validaciones
            const errores = [];
            
            if (this.segmentos.length === 0 && !['D', 'ND'].includes(this.tipoTurno)) {
                errores.push('Debe tener al menos 1 segmento');
            }
            
            if (this.segmentos.length > 8) {
                errores.push('Máximo 8 segmentos permitidos');
            }
            
            // Validar continuidad
            for (let i = 0; i < this.segmentos.length - 1; i++) {
                if (this.segmentos[i].fin !== this.segmentos[i + 1].inicio) {
                    errores.push(`Gap detectado entre ${this.segmentos[i].fin} y ${this.segmentos[i + 1].inicio}`);
                }
            }
            
            // Validar tipo Normal
            if (this.tipoTurno === 'N') {
                if (this.segmentos.length !== 1) {
                    errores.push('Los turnos normales deben tener exactamente 1 segmento');
                } else if (this.segmentos[0].tipo !== 'NORMAL') {
                    errores.push('Los turnos normales solo pueden tener segmentos de tipo NORMAL');
                }
            }
            
            // Validar duración esperada
            const duracionActual = this.calcularDuracionTotal();
            const duracionError = this.validarDuracionEsperada(duracionActual);
            if (duracionError) {
                errores.push(duracionError);
            }
            
            // Mostrar errores
            this.mostrarErrores(errores);
            
            // Mostrar información de duración
            this.mostrarInfoDuracion(duracionActual);
            
            return errores.length === 0;
        }
        
        calcularDuracionTotal() {
            if (this.segmentos.length === 0) return 0;
            
            let duracionTotal = 0;
            
            for (const segmento of this.segmentos) {
                const inicio = this.parseTime(segmento.inicio);
                const fin = this.parseTime(segmento.fin);
                
                let duracion = fin - inicio;
                if (duracion < 0) {
                    duracion += 24; // Si cruza medianoche
                }
                
                duracionTotal += duracion;
            }
            
            return duracionTotal;
        }
        
        parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours + minutes / 60;
        }
        
        validarDuracionEsperada(duracionActual) {
            const duracionesEsperadas = {
                'N': [8, 8],     // Normal: exactamente 8 horas
                'F': [6, 10],    // Festivo: entre 6 y 10 horas
                'FO': [6, 10],   // Festivo Ordinario: entre 6 y 10 horas
                'E': [4, 12],    // Especial: entre 4 y 12 horas
                'D': [0, 0],     // Descanso: 0 horas
                'ND': [0, 0],    // No Devengado: 0 horas
            };
            
            if (!duracionesEsperadas[this.tipoTurno]) return null;
            
            const [min, max] = duracionesEsperadas[this.tipoTurno];
            
            if (min === max) {
                if (Math.abs(duracionActual - min) > 0.1) {
                    return `Los turnos de tipo ${this.getTipoDisplay()} deben tener exactamente ${min} horas. Duración actual: ${duracionActual.toFixed(1)} horas`;
                }
            } else {
                if (duracionActual < min || duracionActual > max) {
                    return `Los turnos de tipo ${this.getTipoDisplay()} deben tener entre ${min} y ${max} horas. Duración actual: ${duracionActual.toFixed(1)} horas`;
                }
            }
            
            return null;
        }
        
        getTipoDisplay() {
            const tipos = {
                'N': 'Normal',
                'F': 'Festivo',
                'FO': 'Festivo Ordinario',
                'E': 'Especial',
                'D': 'Descanso',
                'ND': 'No Devengado'
            };
            return tipos[this.tipoTurno] || this.tipoTurno;
        }
        
        mostrarInfoDuracion(duracionActual) {
            $('.duracion-info').remove();
            $('.duracion-counter').remove();
            
            const duracionesEsperadas = {
                'N': [8, 8],
                'F': [6, 10],
                'FO': [6, 10],
                'E': [4, 12],
                'D': [0, 0],
                'ND': [0, 0],
            };
            
            // Mostrar contador de duración
            const counterHtml = `
                <div class="duracion-counter">
                    <strong>⏱️ Duración Total:</strong> ${duracionActual.toFixed(1)} horas
                </div>
            `;
            $('.segmentos-container').before(counterHtml);
            
            if (duracionesEsperadas[this.tipoTurno]) {
                const [min, max] = duracionesEsperadas[this.tipoTurno];
                let duracionEsperada = '';
                
                if (min === max) {
                    duracionEsperada = `Exactamente ${min} horas`;
                } else {
                    duracionEsperada = `Entre ${min} y ${max} horas`;
                }
                
                const esValida = min === max ? 
                    Math.abs(duracionActual - min) <= 0.1 :
                    duracionActual >= min && duracionActual <= max;
                
                const color = esValida ? 'green' : 'red';
                const icono = esValida ? '✅' : '❌';
                
                const infoHtml = `
                    <div class="duracion-info tipo-turno-info" style="border-left: 4px solid ${color};">
                        <strong>${icono} Duración:</strong> ${duracionActual.toFixed(1)} horas / ${duracionEsperada}
                    </div>
                `;
                
                $('.segmentos-container').before(infoHtml);
            }
            
            // Actualizar el campo de duración total
            $('#id_duracion_total').val(duracionActual.toFixed(1));
        }
        
        actualizarSegmentosDesdeDOM() {
            console.log('🔄 Actualizando segmentos desde DOM...');
            this.segmentos = [];
            
            $('.segmento-item').each((index, elemento) => {
                const $elemento = $(elemento);
                let inicio = $elemento.find('.segmento-inicio').val();
                let fin = $elemento.find('.segmento-fin').val();
                const tipo = $elemento.find('.segmento-tipo').val();
                
                console.log(`📋 Segmento ${index + 1} valores originales:`, { inicio, fin, tipo });
                
                // Asegurar que las horas estén en formato de 24 horas
                if (inicio) {
                    // Convertir de formato 12 horas a 24 horas si es necesario
                    if (inicio.includes('AM') || inicio.includes('PM')) {
                        inicio = this.convertirA24Horas(inicio);
                        console.log(`🔄 Inicio convertido: ${inicio}`);
                    }
                    
                    // Validar y corregir formato
                    const [horasInicio, minutosInicio] = inicio.split(':');
                    const horaInicioNum = parseInt(horasInicio);
                    const minutoInicioNum = parseInt(minutosInicio);
                    
                    if (horaInicioNum >= 0 && horaInicioNum <= 23 && minutoInicioNum >= 0 && minutoInicioNum <= 59) {
                        inicio = `${horaInicioNum.toString().padStart(2, '0')}:${minutoInicioNum.toString().padStart(2, '0')}`;
                    } else {
                        console.error(`❌ Formato de hora de inicio inválido: ${inicio}`);
                    }
                }
                
                if (fin) {
                    // Convertir de formato 12 horas a 24 horas si es necesario
                    if (fin.includes('AM') || fin.includes('PM')) {
                        fin = this.convertirA24Horas(fin);
                        console.log(`🔄 Fin convertido: ${fin}`);
                    }
                    
                    // Validar y corregir formato
                    const [horasFin, minutosFin] = fin.split(':');
                    const horaFinNum = parseInt(horasFin);
                    const minutoFinNum = parseInt(minutosFin);
                    
                    if (horaFinNum >= 0 && horaFinNum <= 23 && minutoFinNum >= 0 && minutoFinNum <= 59) {
                        fin = `${horaFinNum.toString().padStart(2, '0')}:${minutoFinNum.toString().padStart(2, '0')}`;
                    } else {
                        console.error(`❌ Formato de hora de fin inválido: ${fin}`);
                    }
                }
                
                const segmento = {
                    inicio: inicio,
                    fin: fin,
                    tipo: tipo
                };
                
                console.log(`📋 Segmento ${index + 1} valores finales:`, segmento);
                this.segmentos.push(segmento);
            });
            
            console.log('✅ Segmentos actualizados:', this.segmentos);
        }
        
        mostrarErrores(errores) {
            $('.segmentos-error').remove();
            
            if (errores.length > 0) {
                const errorHtml = `
                    <div class="segmentos-error tipo-turno-info error">
                        <strong>⚠️ Errores de validación:</strong>
                        <ul>
                            ${errores.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
                $('.segmentos-container').before(errorHtml);
            }
        }
        
        actualizarJSON() {
            $('#id_segmentos_horas').val(JSON.stringify(this.segmentos));
            
            // También actualizar la duración total
            const duracionActual = this.calcularDuracionTotal();
            $('#id_duracion_total').val(duracionActual.toFixed(1));
        }
    }
    
    // Inicializar cuando el DOM esté listo
    $(document).ready(function() {
        console.log('🔍 Inicializando interfaz de códigos de turno...');
        
        // Verificar si el campo segmentos_horas existe
        const segmentosField = $('#id_segmentos_horas');
        console.log('📋 Campo segmentos_horas encontrado:', segmentosField.length > 0);
        
        // Verificar si ya existen controles de segmentos
        const segmentosContainer = $('.segmentos-container');
        console.log('📦 Contenedor de segmentos existente:', segmentosContainer.length > 0);
        
        // Agregar controles de segmentos si no existen
        if (segmentosContainer.length === 0) {
            console.log('➕ Agregando controles de segmentos...');
            const controlesHTML = `
                <div class="segmentos-container">
                    <h4>Configuración de Segmentos</h4>
                    <div class="controles-segmentos">
                        <button type="button" class="btn-segmento success btn-agregar-segmento">
                            ➕ Agregar Segmento
                        </button>
                        <button type="button" class="btn-segmento btn-plantilla" data-plantilla="N">
                            📋 Normal
                        </button>
                        <button type="button" class="btn-segmento btn-plantilla" data-plantilla="F">
                            📋 Festivo
                        </button>
                        <button type="button" class="btn-segmento btn-plantilla" data-plantilla="E">
                            📋 Especial
                        </button>
                    </div>
                    <div class="segmentos-lista"></div>
                </div>
            `;
            
            segmentosField.closest('.form-row').after(controlesHTML);
            console.log('✅ Controles de segmentos agregados');
        }
        
        // Inicializar la interfaz
        console.log('🚀 Inicializando CodigoTurnoAdmin...');
        new CodigoTurnoAdmin();
        console.log('✅ Interfaz inicializada correctamente');
    });
    
})(django.jQuery);
</script>
{% endblock %}