{% load i18n static %}
{% load static %}
<nav class="sidebar regency-sidebar" id="sidebar">
    <!-- Toggle Button Mejorado -->
    <div class="sidebar-toggle" onclick="toggleSidebar()">
        <span class="toggle-icon">‚ò∞</span>
    </div>
    
    <div class="sidebar-header">
 
    </div>
    
    <!-- Contenedor del men√∫ que se puede ocultar -->
    <div class="sidebar-content" id="sidebarContent">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/welcome/" class="nav-link {% if request.resolver_match.url_name == 'welcome' %}active{% endif %}" data-tooltip="Inicio">
                    <span class="nav-icon"></span>
                    <span class="nav-text">Inicio</span>
                </a>
            </li>
                                <li>
                        <a href="{% url 'programacion_dashboard' %}" class="submenu-link">
                            <span class="submenu-icon">üìÖ</span>
                            Programaciones
                        </a>
                    </li>
            <!-- Gesti√≥n de Empresas, Proyectos - Desplegable -->
            <li class="nav-item has-submenu">
                <a href="#" class="nav-link" onclick="toggleSubmenu(this)" data-tooltip="Configuraci√≥n General">
                    <span class="nav-text">Configuraci√≥n General</span>
                </a>
                <ul class="submenu">
                    <li>
                        <a href="{% url 'empresas:empresas_list' %}" class="submenu-link">
                            <span class="submenu-icon">üè¢</span>
                            Empresas
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empresas:centros_operativos_list' %}" class="submenu-link">
                            <span class="submenu-icon">üè≠</span>
                            Centros Operativos
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empresas:proyectos_list' %}" class="submenu-link">
                            <span class="submenu-icon">üìÅ</span>
                            Proyectos
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empresas:cargopredefinido_list' %}" class="submenu-link">
                            <span class="submenu-icon">üíº</span>
                            Cargos
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empresas:unidades_negocio_list' %}" class="submenu-link">
                            <span class="submenu-icon">üè™</span>
                            Unidades de Negocio
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'usuarios:centrodecosto_list' %}" class="submenu-link">
                            <span class="submenu-icon">üí∞</span>
                            Centro de Costo
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'bitacora_dashboard' %}" class="submenu-link">
                            <span class="submenu-icon">üìù</span>
                            Bit√°cora
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'usuarios:tercero_list' %}" class="submenu-link">
                            <span class="submenu-icon">üë•</span>
                            Terceros
                        </a>
                    </li>
                </ul>
            </li>
                
            <!-- Gesti√≥n de Usuarios - Desplegable -->
            <li class="nav-item has-submenu">
                <a href="#" class="nav-link" onclick="toggleSubmenu(this)" data-tooltip="Configuraci√≥n Usuarios">
                    <span class="nav-text">Configuraci√≥n Usuarios</span>
                </a>
                <ul class="submenu">
                    <!-- Lista de Usuarios (Terceros) -->
                    <li>
                        <a href="{% url 'usuarios:user_list' %}" class="submenu-link">
                            <span class="submenu-icon"></span>
                            Usuarios
                        </a>
                    </li>                   
                    <!-- Grupos de Permisos -->
                    <li>
                        <a href="{% url 'usuarios:group_list' %}" class="submenu-link">
                            <span class="submenu-icon"></span>
                            Grupos de Permisos
                        </a>
                    </li>
                    
                </ul>
            </li>

            <!-- Gesti√≥n de Turnos - Desplegable -->
            <li class="nav-item has-submenu">
                <a href="#" class="nav-link" onclick="toggleSubmenu(this)" data-tooltip="Turnos">
                    <span class="nav-text">Configuraci√≥n Programacion</span>
                </a>
                <ul class="submenu">
                    <li>
                        <a href="{% url 'programacion_models:modeloturno_list' %}" class="submenu-link">
                            <span class="submenu-icon">üìã</span>
                            Modelos de Turno
                        </a>
                    </li>
                    
                           
            <li>
                <a href="{% url 'usuarios:codigoturno_list' %}" class="submenu-link">
                    <span class="submenu-icon">üìã</span>
                    C√≥digos de Turno
                </a>
            </li>
        
                    
                    <li>
                        <a href="{% url 'programacion_dashboard' %}" class="submenu-link">
                            <span class="submenu-icon">üìÖ</span>
                            Programaciones
                        </a>
                    </li>
                </ul>
            </li>


        </ul>
    </div>
</nav>


<script>
// Variables globales para persistencia
let sidebarState = {
    collapsed: false,
    openSubmenus: []
};

// Funci√≥n para cargar estado desde localStorage (SINCRONIZADA)
function loadSidebarState() {
    try {
        const saved = localStorage.getItem('regency_sidebar_state');
        if (saved) {
            sidebarState = JSON.parse(saved);
            console.log('Sidebar state loaded:', sidebarState);
        }
    } catch (e) {
        console.warn('Error loading sidebar state:', e);
        sidebarState = { collapsed: false, openSubmenus: [] };
    }
}

// CARGAR ESTADO INMEDIATAMENTE (antes del DOMContentLoaded)
loadSidebarState();

// Funci√≥n para guardar estado en localStorage
function saveSidebarState() {
    try {
        localStorage.setItem('regency_sidebar_state', JSON.stringify(sidebarState));
        console.log('Sidebar state saved:', sidebarState);
    } catch (e) {
        console.warn('Error saving sidebar state:', e);
    }
}

// Funci√≥n para generar ID √∫nico para submen√∫s
function getSubmenuId(element) {
    const navText = element.querySelector('.nav-text');
    if (navText) {
        const text = navText.textContent.trim();
        return 'submenu-' + text.toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/[^a-z0-9-]/g, '');
    }
    return 'submenu-' + Date.now(); // Fallback
}

// Funci√≥n para restaurar submen√∫s abiertos
function restoreOpenSubmenus() {
    const sidebar = document.getElementById('sidebar');
    
    // Solo restaurar si el sidebar no est√° colapsado
    if (!sidebar.classList.contains('collapsed')) {
        sidebarState.openSubmenus.forEach(submenuId => {
            // Buscar el elemento de navegaci√≥n correspondiente
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                const generatedId = getSubmenuId(link);
                if (generatedId === submenuId) {
                    const submenu = link.nextElementSibling;
                    if (submenu && submenu.classList && submenu.classList.contains('submenu')) {
                        submenu.style.display = 'block';
                    }
                }
            });
        });
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarContent = document.getElementById('sidebarContent');
    const toggleIcon = document.querySelector('.toggle-icon');
    
    // Toggle el estado colapsado
    sidebar.classList.toggle('collapsed');
    
    // Actualizar estado global
    sidebarState.collapsed = sidebar.classList.contains('collapsed');
    
    // Buscar el contenido principal
    const mainContent = document.querySelector('.regency-main-content') || 
                       document.querySelector('.main-content') || 
                       document.querySelector('.content-container') ||
                       document.querySelector('main');
    
    if (sidebarState.collapsed) {
        // Sidebar colapsado - ajustar contenido para usar m√°s espacio
        sidebarContent.style.display = 'none';
        toggleIcon.style.transform = 'rotate(90deg)';
        
        // Ajustar margen del contenido principal
        if (mainContent) {
            mainContent.style.marginLeft = '48px';
            mainContent.style.width = 'calc(100% - 48px)';
            mainContent.style.transition = 'all 0.3s ease';
        }
        
        // Cerrar todos los submen√∫s pero recordar cu√°les estaban abiertos
        document.querySelectorAll('.submenu').forEach(sm => {
            sm.style.display = 'none';
        });
        
    } else {
        // Sidebar expandido - ajustar contenido al tama√±o normal
        sidebarContent.style.display = 'block';
        toggleIcon.style.transform = 'rotate(0deg)';
        
        // Ajustar margen del contenido principal
        if (mainContent) {
            mainContent.style.marginLeft = '200px';
            mainContent.style.width = 'calc(100% - 200px)';
            mainContent.style.transition = 'all 0.3s ease';
        }
        
        // Restaurar submen√∫s que estaban abiertos
        setTimeout(() => {
            restoreOpenSubmenus();
        }, 50);
    }
    
    // Guardar estado actualizado
    saveSidebarState();
    
    // Disparar evento resize para que otros componentes se ajusten
    setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
    }, 300);
}

function toggleSubmenu(element) {
    // Si est√° colapsado, no hacer nada
    const sidebar = document.getElementById('sidebar');
    if (sidebar.classList.contains('collapsed')) {
        return;
    }
    
    const submenu = element.nextElementSibling;
    const submenuId = getSubmenuId(element);
    const isOpen = submenu.style.display === 'block';
    
    // Cerrar todos los otros submen√∫s y actualizar estado
    document.querySelectorAll('.submenu').forEach(sm => {
        if (sm !== submenu) {
            sm.style.display = 'none';
        }
    });
    
    // Limpiar todos los submen√∫s del estado excepto el actual
    sidebarState.openSubmenus = sidebarState.openSubmenus.filter(id => id === submenuId);
    
    // Toggle actual submenu
    if (isOpen) {
        submenu.style.display = 'none';
        // Remover del estado
        sidebarState.openSubmenus = sidebarState.openSubmenus.filter(id => id !== submenuId);
    } else {
        submenu.style.display = 'block';
        // A√±adir al estado si no existe
        if (!sidebarState.openSubmenus.includes(submenuId)) {
            sidebarState.openSubmenus.push(submenuId);
        }
    }
    
    // Guardar estado actualizado
    saveSidebarState();
}

// Funci√≥n INMEDIATA para aplicar estado inicial (SIN DELAY)
function applySidebarInitialStateImmediate() {
    const sidebar = document.getElementById('sidebar');
    const sidebarContent = document.getElementById('sidebarContent');
    const toggleIcon = document.querySelector('.toggle-icon');
    
    if (!sidebar || !sidebarContent || !toggleIcon) {
        return; // Elementos no disponibles a√∫n
    }
    
    // APLICAR ESTADO INMEDIATAMENTE SIN TRANSICIONES
    sidebar.style.transition = 'none';
    sidebarContent.style.transition = 'none';
    
    // Buscar el contenido principal
    const mainContent = document.querySelector('.regency-main-content') || 
                       document.querySelector('.main-content') || 
                       document.querySelector('.content-container') ||
                       document.querySelector('main');
    
    if (sidebarState.collapsed) {
        // Aplicar estado colapsado INMEDIATAMENTE
        sidebar.classList.add('collapsed');
        sidebarContent.style.display = 'none';
        toggleIcon.style.transform = 'rotate(90deg)';
        
        if (mainContent) {
            mainContent.style.marginLeft = '48px';
            mainContent.style.width = 'calc(100% - 48px)';
            mainContent.style.transition = 'none';
        }
    } else {
        // Aplicar estado expandido INMEDIATAMENTE
        sidebar.classList.remove('collapsed');
        sidebarContent.style.display = 'block';
        toggleIcon.style.transform = 'rotate(0deg)';
        
        if (mainContent) {
            mainContent.style.marginLeft = '200px';
            mainContent.style.width = 'calc(100% - 200px)';
            mainContent.style.transition = 'none';
        }
        
        // Restaurar submen√∫s inmediatamente
        restoreOpenSubmenus();
    }
    
    // Marcar como inicializado y restaurar transiciones
    sidebar.classList.add('js-initialized');
    
    // Restaurar transiciones despu√©s de aplicar estado
    setTimeout(() => {
        sidebar.style.transition = '';
        sidebarContent.style.transition = '';
        if (mainContent) {
            mainContent.style.transition = 'all 0.3s ease';
        }
    }, 50);
}

// EJECUTAR INMEDIATAMENTE cuando est√© disponible el DOM b√°sico
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSidebar);
} else {
    // DOM ya est√° listo
    initializeSidebar();
}

function initializeSidebar() {
    // Aplicar estado inmediatamente
    applySidebarInitialStateImmediate();
    
    // Buscar el header corporativo
    var header = document.querySelector('.regency-header-admin') || 
                 document.querySelector('header') || 
                 document.querySelector('.site-header');
    var sidebar = document.getElementById('sidebar');
    
    function applyHeaderHeight() {
        var h = header ? header.offsetHeight : 0;
        document.documentElement.style.setProperty('--header-height', h + 'px');
        if (sidebar) {
            sidebar.style.top = h + 'px';
            sidebar.style.height = 'calc(100vh - ' + h + 'px)';
        }
    }
    
    // Aplicar header height
    applyHeaderHeight();
    window.addEventListener('resize', applyHeaderHeight);
    
    console.log('Sidebar initialized with state:', sidebarState);
}

// Funci√≥n de utilidad para resetear el estado (para debug)
function resetSidebarState() {
    localStorage.removeItem('regency_sidebar_state');
    sidebarState = { collapsed: false, openSubmenus: [] };
    applySidebarInitialStateImmediate();
    console.log('Sidebar state reset');
}

// Exponer funciones globalmente para debug
window.regencySidebar = {
    resetState: resetSidebarState,
    getState: () => sidebarState,
    saveState: saveSidebarState,
    loadState: loadSidebarState
};
</script>

<!-- Incluir CSS -->
<link rel="stylesheet" href="{% static 'admin/css/sidebar.css' %}?v=1.1">